<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PantaMeteo</title>
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PantaMeteo">
<meta name="theme-color" content="#0f172a">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;color:#1e293b;min-height:100vh}
.container{max-width:920px;margin:0 auto;padding:16px}
h1{font-size:36px;font-weight:900;color:#0f172a;text-align:center;letter-spacing:-0.5px;margin:20px 0 4px}
.sub{font-size:14px;color:#64748b;text-align:center;margin:4px 0 24px}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.cbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
.cbar>span{font-size:13px;font-weight:600;color:#374151}
.cbtn{padding:5px 12px;border-radius:20px;border:1px solid #d1d5db;background:#fff;color:#4b5563;font-size:12px;font-weight:500;cursor:pointer;transition:.15s}
.cbtn.on{border-color:#3b82f6;background:#eff6ff;color:#2563eb}
.wind-tog{font-size:11px;padding:4px 12px;border-radius:14px;background:#0ea5e9;color:#fff;border-color:#0ea5e9;font-weight:600;transition:.2s}
.wind-tog.on{opacity:.5;background:transparent;color:#374151;border-color:#cbd5e1;font-weight:400}
.cbtn:hover{border-color:#93c5fd}
.fav-toggle{font-size:12px;font-weight:600;color:#1e293b}
.fav-toggle:hover{opacity:.8}
.city-active{font-size:18px;font-weight:700;color:#1e293b}
.city-star{font-size:18px;cursor:pointer;margin-left:6px;transition:.2s}
.star-off{color:#9ca3af;opacity:.5}
.star-off:hover{opacity:.8}
.star-on{color:#eab308;opacity:1}
.fav-list{padding-top:0;flex-wrap:wrap}
.swrap{position:relative}
.swrap input{width:100%;padding:8px 14px;border-radius:8px;border:1px solid #d1d5db;font-size:13px;outline:none}
.swrap input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.fav-hint{font-size:11px;color:#9ca3af;margin-left:8px;white-space:nowrap}
.dd{position:absolute;top:100%;left:0;right:0;z-index:10;background:#fff;border:1px solid #d1d5db;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-top:4px;overflow:hidden;display:none}
.ddi{padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid #f3f4f6}
.ddi:last-child{border-bottom:none}
.ddi:hover{background:#f0f9ff}
.wg{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
.wr{display:flex;flex-direction:column;align-items:center;padding:8px 6px;border-radius:10px;cursor:pointer;border:1px solid #e5e7eb;background:#fff;transition:.15s;flex-shrink:0;min-width:72px;gap:2px}
.wr:hover{border-color:#93c5fd}
.wr.on{background:#eff6ff;border:2px solid #3b82f6}
.wr-date{font-size:11px;font-weight:700;text-transform:capitalize;text-align:center}
.wr-ico{font-size:24px}
.wr-desc{font-size:9px;color:#6b7280;text-align:center;line-height:1.2}
.wr-temps{font-size:13px;font-weight:600;white-space:nowrap}
.wr-prec{font-size:10px;color:#60a5fa}
.dc{border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:.15s;border:1px solid #e5e7eb;background:#fff}
.dc:hover{border-color:#93c5fd}
.dc.on{background:#eff6ff;border:2px solid #3b82f6}
.dl{font-size:13px;font-weight:700;text-transform:capitalize}
.dd2{font-size:11px;color:#9ca3af;margin-bottom:6px}
.di{font-size:30px}
.ddsc{font-size:10px;color:#6b7280;margin-top:2px}
.dt{margin-top:6px}
.tmx{font-weight:700;color:#ef4444;font-size:15px}
.tmn{font-weight:600;color:#3b82f6;font-size:14px}
.tsp{color:#9ca3af;margin:0 3px}
.dp{font-size:11px;color:#6b7280;margin-top:2px}
.cb{font-size:9px;font-weight:600;margin-top:6px;padding:2px 6px;border-radius:6px;display:inline-block}
.dh{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.dh h2{font-size:15px;font-weight:700;color:#374151}
.tb{display:flex;gap:4px}
.tbtn{padding:6px 14px;border-radius:8px;border:1px solid #d1d5db;background:#fff;color:#4b5563;font-size:12px;font-weight:600;cursor:pointer}
.tbtn.on{border-color:#3b82f6;background:#2563eb;color:#fff}
.ss{font-size:13px;color:#6b7280;margin-top:4px}
.mg{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.mc{background:#fff;border-radius:12px;padding:16px;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.ml{font-size:13px;color:#6b7280;margin-bottom:8px}
.mv{font-size:28px;font-weight:700;color:#111827}
.mu{font-size:14px;font-weight:400}
.mr{font-size:12px;color:#6b7280;margin-top:4px}
.mconf{display:inline-block;margin-top:8px;font-size:11px;font-weight:600;padding:2px 8px;border-radius:8px}
.sb{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:16px;font-size:13px;color:#0c4a6e}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{border-bottom:2px solid #e5e7eb}
th{padding:8px;color:#6b7280;font-weight:600}
td{padding:10px 8px}
tbody tr{border-bottom:1px solid #f3f4f6}
tbody tr:nth-child(even){background:#fafafa}
.mn{font-weight:600}.mm{font-size:11px;color:#9ca3af}
.ld{text-align:center;padding:40px;color:#6b7280;font-size:14px}
.err{background:#fee2e2;border:1px solid #fca5a5;border-radius:12px;padding:16px;color:#991b1b;text-align:center;font-size:14px;margin-bottom:16px}
.ft{margin-top:16px;text-align:center;font-size:12px;color:#9ca3af;padding:8px 0}
.meth-byline{cursor:pointer;font-size:13px;margin-top:-20px!important;margin-bottom:20px!important;color:#6b7280;transition:color .2s}
.meth-byline:hover{color:#374151}
.meth-cta{color:#2563eb;font-variant:normal;font-weight:500;border-bottom:1px dotted rgba(37,99,235,0.4);transition:border-color .2s}
.meth-byline:hover .meth-cta{border-bottom-color:#2563eb}
.meth-overlay{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:none;justify-content:center;align-items:flex-start;padding:24px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.meth-overlay.open{display:flex}
.hr-popup{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:none;justify-content:center;align-items:center;padding:16px}
.hr-popup.open{display:flex}
.hr-popup-box{background:#1e293b;color:#e2e8f0;max-width:600px;width:100%;border-radius:16px;padding:20px 24px;position:relative;box-shadow:0 24px 48px rgba(0,0,0,0.4);max-height:80vh;overflow-y:auto}
.hr-popup-box .hr-close{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#94a3b8}
.hr-popup-box h3{margin:0 0 4px;font-size:16px;font-weight:700}
.hr-popup-box .hr-sub{font-size:12px;color:#94a3b8;margin-bottom:12px}
.hr-popup-row{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);font-size:13px}
.hr-popup-row:last-child{border-bottom:none}
.hr-popup-row .hr-rank{width:20px;color:#64748b;font-size:11px;flex-shrink:0}
.hr-popup-row .hr-dot{width:8px;height:8px;border-radius:50%;margin-right:8px;flex-shrink:0}
.hr-popup-row .hr-mname{min-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1}
.hr-popup-row .hr-mvals{display:flex;gap:10px;flex-shrink:0;font-variant-numeric:tabular-nums;margin-left:8px}
.hr-popup-row .hr-mvals span{min-width:42px;text-align:right}
.hr-popup-avg{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.15);font-size:13px;font-weight:600;display:flex;justify-content:space-between}
@media(prefers-color-scheme:light){.hr-popup-box{background:#fff;color:#1e293b;box-shadow:0 24px 48px rgba(0,0,0,0.15)}.hr-popup-box .hr-close{background:rgba(0,0,0,0.06);color:#64748b}.hr-popup-row{border-bottom-color:rgba(0,0,0,0.06)}.hr-popup-avg{border-top-color:rgba(0,0,0,0.15)}.hr-popup-box .hr-sub{color:#64748b}.hr-popup-row .hr-rank{color:#9ca3af}}
.meth-box{background:#fff;color:#1e293b;max-width:800px;width:100%;border-radius:16px;padding:32px 36px;position:relative;box-shadow:0 24px 48px rgba(0,0,0,0.25);margin:auto}
.meth-box .meth-close{position:sticky;top:0;float:right;width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,0.06);border:none;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1;color:#64748b;transition:background .2s}
.meth-box .meth-close:hover{background:rgba(0,0,0,0.12)}
.meth-box h1{font-size:24px;font-weight:700;margin:0 0 6px;color:#0f172a}
.meth-box h2{font-size:19px;font-weight:700;margin:28px 0 10px;color:#0f172a;padding-bottom:6px;border-bottom:2px solid #e2e8f0}
.meth-box h3{font-size:16px;font-weight:600;margin:20px 0 8px;color:#1e293b}
.meth-box p{margin:8px 0;line-height:1.65;font-size:14px}
.meth-box ul,.meth-box ol{margin:8px 0 8px 20px;font-size:14px;line-height:1.65}
.meth-box li{margin:3px 0}
.meth-box a{color:#2563eb;text-decoration:none;border-bottom:1px solid rgba(37,99,235,0.3)}
.meth-box a:hover{border-bottom-color:#2563eb}
.meth-box table{width:100%;border-collapse:collapse;margin:12px 0;font-size:13px}
.meth-box th{background:#f1f5f9;font-weight:600;text-align:left;padding:8px 10px;border:1px solid #e2e8f0}
.meth-box td{padding:7px 10px;border:1px solid #e2e8f0}
.meth-box tr:nth-child(even) td{background:#f8fafc}
.meth-box code{background:#f1f5f9;padding:1px 5px;border-radius:4px;font-size:13px}
.meth-box hr{border:none;height:1px;background:linear-gradient(90deg,transparent,#cbd5e1,transparent);margin:24px 0}
.meth-box em{color:#475569;font-size:13px}
.meth-loading{text-align:center;padding:48px 0;color:#94a3b8;font-size:14px}
.sec-title{font-size:15px;font-weight:800;letter-spacing:0.3px;color:#2563eb;margin:0 0 12px;padding:0}
.card>.sec-title{margin-bottom:8px}
.live-row{display:flex;gap:10px;flex-wrap:wrap}
.lc{flex:1 1 200px;min-width:180px;border-radius:12px;padding:14px 16px;color:#fff;display:flex;align-items:center;gap:14px;text-decoration:none;transition:opacity .15s}
a.lc:hover{opacity:.88}
.lc-icon{font-size:48px;line-height:1;flex-shrink:0}
.lc-data{flex:1;min-width:0}
.lc-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lc-temp{font-size:28px;font-weight:700;line-height:1.1}
.lc-row{font-size:10px;opacity:.85;margin-top:3px}
.lc-ts{font-size:9px;margin-top:5px}
.lc-leg{display:flex;flex-wrap:wrap;gap:6px 14px;justify-content:center;margin-top:8px;font-size:10px;color:#64748b}
.lc-leg i{display:inline-block;width:14px;height:10px;border-radius:3px;vertical-align:middle;margin-right:4px;font-style:normal}
@media(max-width:900px){.lc{flex:1 1 45%;min-width:0}}
@media(max-width:500px){.live-row{gap:6px}.lc{flex:1 1 calc(50% - 3px);min-width:0;padding:8px 10px;gap:8px;border-radius:10px}.lc-icon{font-size:28px}.lc-label{font-size:8px;letter-spacing:0.5px;margin-bottom:1px}.lc-temp{font-size:20px}.lc-row{font-size:9px;margin-top:2px}.lc-ts{font-size:8px;margin-top:3px}.lc-leg{gap:4px 10px;margin-top:6px;font-size:9px}}
.ca{color:#16a34a;background:#dcfce7}
.cm{color:#ca8a04;background:#fef9c3}
.cl{color:#dc2626;background:#fee2e2}
/* Hourly chart */
.hc-wrap{position:relative;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:8px}
.hc-row{display:flex;min-width:max-content;position:relative}
.hc-col{display:flex;flex-direction:column;align-items:center;width:56px;flex-shrink:0;position:relative;z-index:1}
.hc-hr{font-size:11px;font-weight:600;color:#374151;margin-bottom:4px}
.hc-ico{font-size:18px;margin-bottom:2px;line-height:1}
.hc-val{font-size:15px;font-weight:700;color:#1e293b;margin-bottom:4px}
.hc-svg{position:absolute;top:0;left:0;pointer-events:none;z-index:0}
.hc-sec{margin-top:18px;padding-top:18px;position:relative}
.hc-sec:first-child{margin-top:0;padding-top:0}
.hc-sec+.hc-sec::before{content:none}
.hc-title{font-size:13px;font-weight:700;color:#374151;margin-bottom:8px}
.hc-legend{display:flex;gap:14px;margin-top:10px;flex-wrap:wrap;font-size:14px;color:#374151}
.hc-legend span{display:flex;align-items:center;gap:4px}
.hc-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.stog{font-size:12px;color:#6b7280;cursor:pointer;text-align:center;padding:4px;margin-bottom:8px}
.stog:hover{color:#3b82f6}
.spnl{display:none;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px}
.spnl.open{display:block}
.spnl label{font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px}
.spnl input{width:100%;padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;margin-bottom:8px;outline:none}
.spnl button{padding:6px 16px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer}
@media(max-width:600px){
  .mg{grid-template-columns:1fr 1fr}
  .wg{gap:4px}
  .wr{padding:6px 4px;min-width:66px;border-radius:8px}
  .wr-date{font-size:11px}
  .wr-ico{font-size:22px}
  .wr-desc{font-size:9px}
  .wr-temps{font-size:13px}
  .wr-prec{font-size:10px}
  .dc{padding:10px}
  table{font-size:12px}
  th,td{padding:6px 4px}
  .container{padding:8px}
  h1{font-size:32px;margin:16px 0 2px}
  .sub{font-size:13px;margin:2px 0 12px}
  .card{padding:12px;margin-bottom:10px;border-radius:8px}
  .cbar{gap:6px;margin-bottom:6px}
  .cbtn{padding:5px 12px;font-size:13px}
  .swrap input{padding:8px 12px;font-size:14px}
  .dh{margin-bottom:8px;gap:4px}
  .dh h2{font-size:15px}
  .tbtn{padding:5px 12px;font-size:13px}
  .lc{flex:1 1 calc(50% - 4px);min-width:0;padding:10px 12px;gap:10px}
  .lc-icon{font-size:30px}
  .lc-temp{font-size:20px}
  .lc-row{font-size:9px;margin-top:2px}
  .lc-label{font-size:9px}
  .lc-ts{font-size:8px}
  .ss{font-size:13px;margin-top:2px}
  .hc-legend{gap:10px;margin-top:6px;font-size:12px}
  .hc-title{font-size:13px;margin-bottom:4px}
  .hc-sec{margin-top:10px;padding-top:10px}
  .hc-val{font-size:14px!important}
  .hc-hr{font-size:11px!important}
  .hc-ico{font-size:16px!important}
  .hc-col{width:48px!important}
  .sb{padding:10px;font-size:13px;margin-top:8px}
  .wr-date{font-size:11px!important}
  .wr-desc{font-size:10px!important}
  .wr-temps{font-size:14px!important}
  .wr-prec{font-size:10px!important}
  .city-active{font-size:22px!important}
  .fav-hint{font-size:10px;white-space:normal}
  .city-star{font-size:20px!important}
  .fav-toggle{font-size:13px!important}
  .meth-byline{font-size:12px;margin-top:-10px!important;margin-bottom:10px!important}
  .meth-overlay{padding:8px}
  .meth-box{padding:20px 18px;border-radius:12px}
  .meth-box h1{font-size:20px}
  .meth-box h2{font-size:16px}
  .meth-box table{font-size:11px}
  .meth-box th,.meth-box td{padding:5px 6px}
  .hr-popup-box{padding:16px 14px;max-width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .hr-popup-box h3{font-size:15px}
  .hr-popup-row{font-size:12px;min-width:480px}
  .hr-popup-row .hr-mname{min-width:100px}
  .hr-popup-row .hr-mvals{gap:6px}
  .hr-popup-row .hr-mvals span{min-width:36px}
  .hr-popup-avg{min-width:480px}
}
.aff-badge{justify-content:center;gap:6px;background:rgba(0,0,0,0.05);border:1px solid rgba(0,0,0,0.1);border-radius:20px;padding:5px 14px;display:inline-flex;align-items:center;font-weight:600;letter-spacing:0.3px;font-size:12px}
@media(prefers-color-scheme:dark){
  body{background:#0f172a;color:#e2e8f0}
  h1{color:#ffffff}
  .sub{color:#cbd5e1}
  .card{background:#1e293b;border-color:#334155}
  .cbar>span{color:#cbd5e1}
  .city-active{color:#fff}
  .star-off{color:#64748b}
  .fav-toggle{color:#e2e8f0;border-color:#e2e8f0}
  .cbtn{background:#1e293b;color:#cbd5e1;border-color:#475569}
  .cbtn.on{background:#1e3a5f;color:#7dd3fc;border-color:#3b82f6}
  .wind-tog.on{opacity:.6;background:transparent;color:#cbd5e1;border-color:#475569}
  .swrap input{background:#1e293b;border-color:#94a3b8;color:#fff}
  .swrap input::placeholder{color:#e2e8f0}
  .dd{background:#1e293b;border-color:#475569}
  .ddi{border-color:#334155;color:#e2e8f0}
  .ddi:hover{background:#334155}
  .dc{background:#1e293b;border-color:#334155}
  .wr{background:#1e293b;border-color:#334155}
  .wr.on{background:#1e3a5f;border-color:#3b82f6}
  .wr-desc{color:#cbd5e1}
  .dc:hover{border-color:#60a5fa}
  .dc.on{background:#1e3a5f;border-color:#3b82f6}
  .dl,.ddsc,.dp{color:#e2e8f0}
  .dd2{color:#cbd5e1}
  .dh h2{color:#e2e8f0}
  .sec-title{color:#60a5fa}
  .tbtn{background:#1e293b;color:#cbd5e1;border-color:#475569}
  .tbtn.on{background:#2563eb;color:#fff}
  .ss{color:#e2e8f0}
  .mc{background:#1e293b;border-color:#334155}
  .ml{color:#e2e8f0}
  .mv{color:#f1f5f9}
  .mr{color:#e2e8f0}
  .sb{background:#172554;border-color:#1e40af;color:#e2e8f0}
  .ca{color:#4ade80;background:#052e16}
  .cm{color:#facc15;background:#422006}
  .cl{color:#f87171;background:#450a0a}
  thead tr{border-color:#475569}
  th{color:#e2e8f0}
  tbody tr{border-color:#334155}
  tbody tr:nth-child(even){background:#1a2332}
  .mm{color:#94a3b8}
  .ld{color:#e2e8f0}
  .err{background:#450a0a;border-color:#991b1b;color:#fca5a5}
  .ft{color:#94a3b8}
  .meth-byline{color:#94a3b8}
  .meth-byline:hover{color:#cbd5e1}
  .meth-cta{color:#60a5fa;border-bottom-color:rgba(96,165,250,0.4)}
  .meth-byline:hover .meth-cta{border-bottom-color:#60a5fa}
  .meth-box{background:#1e293b;color:#e2e8f0}
  .meth-box h1,.meth-box h2,.meth-box h3{color:#f1f5f9}
  .meth-box h2{border-bottom-color:#334155}
  .meth-box .meth-close{background:rgba(255,255,255,0.08);color:#94a3b8}
  .meth-box .meth-close:hover{background:rgba(255,255,255,0.15)}
  .meth-box a{color:#60a5fa;border-bottom-color:rgba(96,165,250,0.3)}
  .meth-box th{background:#334155;border-color:#475569}
  .meth-box td{border-color:#334155}
  .meth-box tr:nth-child(even) td{background:#1a2332}
  .meth-box code{background:#334155;color:#e2e8f0}
  .meth-box hr{background:linear-gradient(90deg,transparent,#475569,transparent)}
  .meth-box em{color:#94a3b8}
  .stog{color:#e2e8f0}
  .spnl{background:#1e293b;border-color:#334155}
  .spnl label{color:#cbd5e1}
  .spnl input{background:#0f172a;border-color:#475569;color:#e2e8f0}
  td{color:#e2e8f0}
  .hc-hr{color:#e2e8f0}
  .hc-val{color:#e2e8f0}
  .hc-title{color:#e2e8f0}
  .hc-legend{color:#e2e8f0}
  .aff-badge{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.12)}
  .wind-tog{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  .terr-box{color:#e2e8f0}
  .terr-cfg-overlay{background:rgba(0,0,0,0.6)}
  .terr-cfg-box{background:#1e293b;color:#e2e8f0}
  .terr-cfg-box label{color:#cbd5e1}
  .terr-cfg-box input[type=range]{accent-color:#60a5fa}
  .terr-cfg-box .tcf-close{background:rgba(255,255,255,0.08);color:#94a3b8}
  .terr-cfg-box .tcf-close:hover{background:rgba(255,255,255,0.15)}
  .terr-cfg-box .tcf-val{color:#94a3b8}
  .terr-cfg-box select{background:#0f172a;border-color:#475569;color:#e2e8f0}
  .terr-details{color:#94a3b8}
  .terr-sub{color:#94a3b8}
  .terr-gear{background:rgba(255,255,255,0.06)}
  .terr-gear:hover{background:rgba(255,255,255,0.12)}
}
.terr-box{display:none}
.terr-head{display:flex;align-items:center;justify-content:space-between}
.terr-verdict{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.terr-sub{font-size:12px;margin-top:6px;color:#64748b}
.terr-details{font-size:12px;color:#64748b;margin-top:8px;line-height:1.6}
.terr-gear{width:28px;height:28px;border-radius:50%;border:none;background:rgba(0,0,0,0.04);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0}
.terr-gear:hover{background:rgba(0,0,0,0.1)}
.terr-cfg-overlay{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:none;justify-content:center;align-items:center;padding:16px}
.terr-cfg-overlay.open{display:flex}
.terr-cfg-box{background:#fff;color:#1e293b;max-width:420px;width:100%;border-radius:16px;padding:24px 28px;position:relative;box-shadow:0 24px 48px rgba(0,0,0,0.2)}
.terr-cfg-box h3{margin:0 0 16px;font-size:16px;font-weight:700}
.terr-cfg-box .tcf-close{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,0.06);border:none;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#64748b;transition:background .2s}
.terr-cfg-box .tcf-close:hover{background:rgba(0,0,0,0.12)}
.terr-cfg-box label{display:block;font-size:12px;font-weight:600;color:#374151;margin:12px 0 4px}
.terr-cfg-box input[type=range]{width:100%;margin:4px 0;accent-color:#2563eb}
.terr-cfg-box .tcf-val{font-size:12px;color:#6b7280;display:flex;justify-content:space-between}
.terr-cfg-row{margin-bottom:8px}
</style>
</head>
<body>
<div class="container">

  <!-- Sezione 1: Header -->
  <h1>PantaMeteo</h1>
  <p class="sub">Previsioni meteo calibrate</p>
  <p class="sub meth-byline" onclick="openMeth()"><span class="meth-cta">nota metodologica ‚Üó</span></p>

  <!-- Sezione 2: Scelta citt√† -->
  <div class="card">
    <div class="cbar" style="justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px">
        <div id="cbtns"></div>
        <button class="cbtn fav-toggle" id="userFavToggle" style="display:none" onclick="toggleUserFav()"><span style="color:#eab308">‚òÖ</span> FAVs</button>
      </div>
    </div>
    <div id="userFavCities" class="cbar fav-list" style="display:none">
      <div id="userFavBtns"></div>
    </div>
    <div class="swrap">
      <input type="text" id="sinp" placeholder="üîç Cerca altra citt√†...">
      <div id="sdd" class="dd"></div>
    </div>
  </div>

  <div class="stog" id="wuTogEl" onclick="document.getElementById('wuPnl').classList.toggle('open')">‚öô Configura stazione Weather Underground</div>
  <div class="spnl" id="wuPnl">
    <label>Station ID</label>
    <input type="text" id="wuSta" placeholder="Es: KMABOSTO391 (pi√π stazioni: ID1, ID2)">
    <button onclick="saveWU()">Salva e collega</button>
    <span id="wuSts" style="font-size:11px;color:#6b7280;margin-left:8px"></span>
  </div>

  <!-- Sezione 3: Dati Live -->
  <div id="secLive" class="sec-title" style="display:none">Dati Live</div>
  <div id="liveCard" class="card" style="display:none">
    <div id="liveContent"></div>
  </div>

  <!-- Loading/Error -->
  <div id="ldEl" class="ld" style="display:none">Caricamento previsioni da 7 modelli...</div>
  <div id="erEl" class="err" style="display:none"></div>

  <!-- Sezione 4: Previsioni -->
  <div id="secPrev" class="sec-title" style="display:none">Previsioni</div>

  <div id="wkCard" class="card" style="display:none">
    <div id="wkTitle" style="margin-bottom:16px"></div>
    <div class="wg" id="wkG"></div>
  </div>

  <div id="legendBadge" style="display:none;text-align:center;margin:-8px 0 16px"></div>

  <!-- Terrazza config popup -->
  <div id="terrCfgOverlay" class="terr-cfg-overlay" onclick="if(event.target===this)closeTerrCfg()">
    <div class="terr-cfg-box">
      <button class="tcf-close" onclick="closeTerrCfg()">‚úï</button>
      <h3>Imposta condizioni ideali</h3>
      <div class="terr-cfg-row">
        <label>Fascia oraria</label>
        <div style="display:flex;align-items:center;gap:8px;font-size:13px">
          <span>dalle</span>
          <select id="tcfHrFrom" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px" onchange="saveTerrCfg()"></select>
          <span>alle</span>
          <select id="tcfHrTo" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px" onchange="saveTerrCfg()"></select>
        </div>
      </div>
      <div class="terr-cfg-row">
        <label>Temperatura: <span id="tcfTempV"></span></label>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="range" id="tcfTempMin" min="0" max="40" step="1" style="flex:1" oninput="updTerrSlider()" onchange="saveTerrCfg()">
          <input type="range" id="tcfTempMax" min="0" max="40" step="1" style="flex:1" oninput="updTerrSlider()" onchange="saveTerrCfg()">
        </div>
        <div class="tcf-val"><span>min</span><span>max</span></div>
      </div>
      <div class="terr-cfg-row">
        <label>Vento: <span id="tcfWindV"></span></label>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="range" id="tcfWindMin" min="0" max="40" step="1" style="flex:1" oninput="updTerrSlider()" onchange="saveTerrCfg()">
          <input type="range" id="tcfWindMax" min="0" max="40" step="1" style="flex:1" oninput="updTerrSlider()" onchange="saveTerrCfg()">
        </div>
        <div class="tcf-val"><span>min</span><span>max</span></div>
      </div>
      <div class="terr-cfg-row">
        <label>Probabilit√† pioggia: <span id="tcfRainV"></span></label>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="range" id="tcfRainMin" min="0" max="100" step="5" style="flex:1" oninput="updTerrSlider()" onchange="saveTerrCfg()">
          <input type="range" id="tcfRainMax" min="0" max="100" step="5" style="flex:1" oninput="updTerrSlider()" onchange="saveTerrCfg()">
        </div>
        <div class="tcf-val"><span>min</span><span>max</span></div>
      </div>
    </div>
  </div>

  <div id="cnt" style="display:none">
    <div class="card">
      <div class="dh">
        <h2 id="dtT"></h2>
        <span id="calBadge" style="display:none;font-size:11px;font-weight:400;margin-left:8px;cursor:pointer" onclick="showWeights()"></span>
      </div>
      <div id="sV"></div>
      <div id="cV" style="display:none"></div>
    </div>
  </div>

  <!-- Sezione 5: Credits -->
  <div class="ft" id="ftEl"></div>
</div>

<div class="hr-popup" id="hrPopup" onclick="if(event.target===this)closeHrPopup()">
<div class="hr-popup-box" id="hrPopupBox"><button class="hr-close" onclick="closeHrPopup()">&times;</button><div id="hrPopupContent"></div></div>
</div>
<div class="meth-overlay" id="methOverlay" onclick="if(event.target===this)closeMeth()">
  <div class="meth-box">
    <button class="meth-close" onclick="closeMeth()" title="Chiudi">‚úï</button>
    <div id="methContent"><div class="meth-loading">Caricamento nota metodologica‚Ä¶</div></div>
  </div>
</div>

<script>
// Auto-update check for PWA
(function(){
  try{
    fetch("/api/version?t="+Date.now()).then(function(r){return r.json();}).then(function(d){
      if(!d.version)return;
      var stored=localStorage.getItem("pm_version");
      if(stored&&stored!==d.version){
        console.log("New version:",d.version,"old:",stored);
        localStorage.setItem("pm_version",d.version);
        if(window.caches){caches.keys().then(function(k){k.forEach(function(n){caches.delete(n);});});}
        window.location.reload(true);
      }else{
        localStorage.setItem("pm_version",d.version);
      }
    }).catch(function(){});
  }catch(e){}
})();

// Methodology modal
var methCache=null;
var METH_URL="/metodologia.md";
function openMeth(){
  document.getElementById("methOverlay").classList.add("open");
  document.body.style.overflow="hidden";
  if(methCache){document.getElementById("methContent").innerHTML=methCache;return;}
  fetch(METH_URL+"?t="+Date.now()).then(function(r){if(!r.ok)throw new Error(r.status);return r.text();}).then(function(md){
    methCache=parseMd(md);
    document.getElementById("methContent").innerHTML=methCache;
  }).catch(function(){
    document.getElementById("methContent").innerHTML='<p style="text-align:center;color:#94a3b8">Impossibile caricare la nota metodologica.<br><a href="'+METH_URL+'" target="_blank">Apri su GitHub</a></p>';
  });
}
function closeMeth(){
  document.getElementById("methOverlay").classList.remove("open");
  document.body.style.overflow="";
}
document.addEventListener("keydown",function(e){if(e.key==="Escape"){if(document.getElementById("hrPopup").classList.contains("open"))closeHrPopup();else if(document.getElementById("methOverlay").classList.contains("open"))closeMeth();}});
function parseMd(md){
  // Simple markdown ‚Üí HTML parser
  var lines=md.split("\n"),html="",inTable=false,inList=false,listType="";
  for(var i=0;i<lines.length;i++){
    var l=lines[i];
    // Horizontal rule
    if(/^---+\s*$/.test(l)){
      if(inList){html+="</"+listType+">";inList=false;}
      if(inTable){html+="</tbody></table>";inTable=false;}
      html+="<hr>";continue;
    }
    // Table
    if(l.indexOf("|")===0||/^\|/.test(l.trim())){
      if(/^\|[\s-:|]+\|$/.test(l.trim()))continue; // separator row
      var cells=l.split("|").filter(function(c,j){return j>0&&j<l.split("|").length-1;});
      if(!inTable){
        if(inList){html+="</"+listType+">";inList=false;}
        html+="<table><thead><tr>";
        cells.forEach(function(c){html+="<th>"+inlineMd(c.trim())+"</th>";});
        html+="</tr></thead><tbody>";inTable=true;
      }else{
        html+="<tr>";
        cells.forEach(function(c){html+="<td>"+inlineMd(c.trim())+"</td>";});
        html+="</tr>";
      }
      continue;
    }
    if(inTable){html+="</tbody></table>";inTable=false;}
    // Headings
    var hm=l.match(/^(#{1,3})\s+(.*)/);
    if(hm){
      if(inList){html+="</"+listType+">";inList=false;}
      var lvl=hm[1].length;
      html+="<h"+lvl+">"+inlineMd(hm[2])+"</h"+lvl+">";continue;
    }
    // Unordered list
    if(/^[\-\*]\s+/.test(l.trim())){
      if(!inList||listType!=="ul"){if(inList)html+="</"+listType+">";html+="<ul>";inList=true;listType="ul";}
      html+="<li>"+inlineMd(l.trim().replace(/^[\-\*]\s+/,""))+"</li>";continue;
    }
    // Ordered list
    var olm=l.trim().match(/^(\d+)\.\s+(.*)/);
    if(olm){
      if(!inList||listType!=="ol"){if(inList)html+="</"+listType+">";html+="<ol>";inList=true;listType="ol";}
      html+="<li>"+inlineMd(olm[2])+"</li>";continue;
    }
    if(inList){html+="</"+listType+">";inList=false;}
    // Empty line
    if(!l.trim()){continue;}
    // Paragraph
    html+="<p>"+inlineMd(l)+"</p>";
  }
  if(inList)html+="</"+listType+">";
  if(inTable)html+="</tbody></table>";
  return html;
}
function inlineMd(s){
  // Bold+italic, bold, italic, code, links
  s=s.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>");
  s=s.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");
  s=s.replace(/\*(.+?)\*/g,"<em>$1</em>");
  s=s.replace(/`(.+?)`/g,"<code>$1</code>");
  s=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  return s;
}

var MODELS=[
  {id:"ecmwf_ifs025",name:"ECMWF IFS",origin:"Centro Europeo",color:"#2563eb",res:"9 km"},
  {id:"ecmwf_aifs025",name:"ECMWF AIFS",origin:"Centro Europeo (AI)",color:"#1d4ed8",res:"25 km"},
  {id:"gfs_seamless",name:"GFS NOAA",origin:"USA",color:"#dc2626",res:"25 km"},
  {id:"icon_seamless",name:"ICON DWD",origin:"Germania",color:"#f59e0b",res:"13 km"},
  {id:"meteofrance_seamless",name:"M√©t√©o-France",origin:"Francia",color:"#8b5cf6",res:"25 km"},
  {id:"jma_seamless",name:"JMA",origin:"Giappone",color:"#ec4899",res:"33 km"},
  {id:"gem_seamless",name:"GEM CMC",origin:"Canada",color:"#10b981",res:"25 km"},
  {id:"ukmo_seamless",name:"UKMO",origin:"Regno Unito",color:"#6366f1",res:"10 km"},
  {id:"italia_meteo_arpae_icon_2i",name:"ItaliaMeteo ARPAE",origin:"Italia",color:"#059669",res:"2 km"},
  {id:"knmi_seamless",name:"KNMI Harmonie",origin:"Paesi Bassi",color:"#0891b2",res:"2.5 km"},
  {id:"meteoswiss_icon_ch2",name:"MeteoSwiss",origin:"Svizzera",color:"#e11d48",res:"2 km"},
  {id:"dmi_seamless",name:"DMI Harmonie",origin:"Danimarca",color:"#f97316",res:"2 km"},
  {id:"metno_seamless",name:"MET Norway",origin:"Norvegia",color:"#14b8a6",res:"1 km"}
];

var CITIES=[
  {name:"Milano",lat:45.4642,lon:9.19},
  {name:"Boston",lat:42.3601,lon:-71.0589},
  {name:"Bormio",lat:46.4685,lon:10.3710},
  {name:"Bressanone",lat:46.7153,lon:11.6563},
  {name:"Chamonix",lat:45.9237,lon:6.8694},
  {name:"Chioggia",lat:45.2193,lon:12.2787},
  {name:"Cortina d'Ampezzo",lat:46.5369,lon:12.1356},
  {name:"Courmayeur",lat:45.7967,lon:6.9690},
  {name:"Garbagnate",lat:45.5756,lon:9.0781},
  {name:"Garbagnate Milanese",lat:45.5756,lon:9.0781},
  {name:"Grottaglie",lat:40.5384,lon:17.4352},
  {name:"London",lat:51.5074,lon:-0.1278},
  {name:"Manduria",lat:40.3964,lon:17.6364},
  {name:"Martina Franca",lat:40.7010,lon:17.3370},
  {name:"M√ºnchen",lat:48.1351,lon:11.5820},
  {name:"Rivisondoli",lat:41.8728,lon:14.0631},
  {name:"Roma",lat:41.9028,lon:12.4964},
  {name:"San Pietro in Bevagna",lat:40.3031,lon:17.6894},
  {name:"Torino",lat:45.0703,lon:7.6869},
  {name:"Treviso",lat:45.6669,lon:12.2430},
  {name:"Venezia",lat:45.4408,lon:12.3155},
  {name:"Verona",lat:45.4384,lon:10.9916}
];

var ICAO={Milano:"LIML","Garbagnate":"LIMC","Garbagnate Milanese":"LIMC",Roma:"LIRF",Manduria:"LIBR","San Pietro in Bevagna":"LIBR",Boston:"KBOS",Chioggia:"LIPZ",Chamonix:"LFLB","Martina Franca":"LIBR",Grottaglie:"LIBG",Bressanone:"LIPB","M√ºnchen":"EDDM",Rivisondoli:"LIBP",Venezia:"LIPZ","Cortina d'Ampezzo":"LIPB",Courmayeur:"LIMH",Bormio:"LSZS",Torino:"LIMF",Treviso:"LIPH",London:"EGLL",Verona:"LIPX"};

var DLBL=["Oggi","Domani","+2gg","+3gg","+4gg","+5gg","+6gg","+7gg","+8gg"];

var S={city:CITIES[0],data:null,current:null,day:0,view:"s",wuData:[],mData:null,mErr:null,weights:null,calStatus:null,showWind:false};
var stm=null;

function wI(c){if(c==null)return"--";if(c===0)return"‚òÄÔ∏è";if(c<=3)return"‚õÖ";if(c<=48)return"üå´Ô∏è";if(c<=57)return"üå¶Ô∏è";if(c<=65)return"üåßÔ∏è";if(c<=75)return"‚ùÑÔ∏è";if(c<=82)return"üåßÔ∏è";if(c<=99)return"‚õàÔ∏è";return"üå§Ô∏è";}
function wD(c){if(c==null)return"N/D";if(c===0)return"Sereno";if(c<=3)return"Parz. nuvoloso";if(c<=48)return"Nebbia";if(c<=57)return"Pioviggine";if(c<=65)return"Pioggia";if(c<=75)return"Neve";if(c<=82)return"Rovesci";if(c<=99)return"Temporale";return"Variabile";}
// Weighted multi-model weather code vote: groups codes by category, sums weights, picks winner
function wxCatOf(c){if(c<=3)return 0;if(c<=48)return 1;if(c<=57)return 2;if(c<=65)return 3;if(c<=77)return 4;if(c<=82)return 5;return 6;}
function votedWx(codes,weights){
  if(!codes||!codes.length)return null;
  // Sum weights per category, track codes per category
  var catW=[0,0,0,0,0,0,0],catBest=[[],[],[],[],[],[],[]];
  for(var i=0;i<codes.length;i++){
    if(codes[i]==null)continue;
    var cat=wxCatOf(codes[i]),w=(weights&&weights[i])?weights[i]:1;
    catW[cat]+=w;
    catBest[cat].push({code:codes[i],w:w});
  }
  // Find category with highest total weight
  var bestCat=0;
  for(var c=1;c<7;c++){if(catW[c]>catW[bestCat])bestCat=c;}
  if(catW[bestCat]===0)return null;
  // Pick most-weighted code within winning category
  var codeW={};
  catBest[bestCat].forEach(function(e){codeW[e.code]=(codeW[e.code]||0)+e.w;});
  var best=null,bw=0;
  Object.keys(codeW).forEach(function(k){if(codeW[k]>bw){bw=codeW[k];best=Number(k);}});
  return best;
}
// Derive WMO weather code from sensor readings (solar radiation, precip, humidity)
function sensorWx(obs,lat){
  if(!obs)return null;
  // 1. Thunderstorm
  if(obs.lightning_strike_count>0){
    if(obs.precip_type===2)return 99; // hail
    if(obs.precip>0||obs.precip_type===1)return 95; // thunder+rain
    return 95;
  }
  // 2. Precipitation
  if(obs.precip_type===2)return 82; // hail without thunder ‚Üí heavy shower
  if(obs.precip>0||obs.precip_type===1){
    // snow if temp<=1
    if(obs.air_temperature!=null&&obs.air_temperature<=1)return obs.precip>2?75:obs.precip>0.5?73:71;
    // rain intensity
    return obs.precip>4?65:obs.precip>1?63:61;
  }
  // 3. Fog: very high humidity + low solar radiation during day
  var isDay=obs.solar_radiation!=null&&obs.solar_radiation>5;
  if(obs.relative_humidity!=null&&obs.relative_humidity>=97){
    if(!isDay||obs.solar_radiation<50)return 45;
  }
  // 4. Cloud cover from solar radiation ratio
  if(obs.solar_radiation!=null&&isDay&&lat!=null){
    // Approximate clear-sky radiation using solar elevation
    var now=obs.timestamp?new Date(obs.timestamp*1000):new Date();
    var doy=Math.floor((now-new Date(now.getFullYear(),0,0))/(864e5));
    var hr=now.getUTCHours()+now.getUTCMinutes()/60;
    var decl=23.45*Math.sin(2*Math.PI*(284+doy)/365)*Math.PI/180;
    var latr=lat*Math.PI/180;
    // Solar hour angle (approximate using longitude from city)
    var lon=S.city?S.city.lon:0;
    var ha=(hr-12)*15+lon;var har=ha*Math.PI/180;
    var sinElev=Math.sin(latr)*Math.sin(decl)+Math.cos(latr)*Math.cos(decl)*Math.cos(har);
    if(sinElev>0.05){
      var clearSky=1000*sinElev; // simplified clear-sky W/m¬≤
      var ratio=obs.solar_radiation/clearSky;
      if(ratio>0.7)return 0; // clear
      if(ratio>0.4)return 2; // partly cloudy
      return 3; // overcast
    }
  }
  // 5. Night or no solar data
  if(!isDay){
    if(obs.relative_humidity!=null&&obs.relative_humidity>=97)return 45; // fog at night
    return 0; // clear night (best guess)
  }
  return 2; // default: partly cloudy
}
function wuWx(d,lat){
  if(!d||!d.metric)return null;
  var m=d.metric;
  // map WU fields to the same shape sensorWx expects
  var obs={
    lightning_strike_count:0,precip_type:0,
    precip:m.precipRate!=null?m.precipRate:0,
    air_temperature:m.temp,
    solar_radiation:d.solarRadiation!=null?d.solarRadiation:null,
    relative_humidity:d.humidity!=null?d.humidity:null,
    timestamp:d.epoch||null
  };
  return sensorWx(obs,lat);
}
function r1(v){return v!=null&&!isNaN(v)?Math.round(v*10)/10:"--";}
function st(vals,wts){
  var pairs=[];
  for(var i=0;i<vals.length;i++){if(vals[i]!=null&&!isNaN(vals[i])){pairs.push({v:vals[i],w:wts&&wts[i]!=null?wts[i]:1});}}
  if(!pairs.length)return{min:"--",max:"--",mean:"--",spread:"--",count:0};
  var vs=pairs.map(function(p){return p.v;});
  var mn=Math.min.apply(null,vs),mx=Math.max.apply(null,vs);
  var wSum=pairs.reduce(function(a,p){return a+p.w;},0);
  var avg=wSum>0?pairs.reduce(function(a,p){return a+p.v*p.w;},0)/wSum:pairs.reduce(function(a,p){return a+p.v;},0)/pairs.length;
  return{min:r1(mn),max:r1(mx),mean:r1(avg),spread:r1(mx-mn),count:pairs.length};
}
function cL(sp,t){var th=t==="temp"?[1.5,3]:t==="precip"?[2,8]:[5,12];if(sp<=th[0])return{text:"Consenso tra provider: alto",cls:"ca"};if(sp<=th[1])return{text:"Consenso tra provider: medio",cls:"cm"};return{text:"Consenso tra provider: basso",cls:"cl"};}
function gm(mid,f,d){if(!S.data)return null;var a=S.data.daily?.[f+"_"+mid];return a?a[d]:null;}
// Get hourly indices for a given day
function dayIdx(d){
  if(!S.data||!S.data.hourly||!S.data.daily||!S.data.daily.time)return[];
  var dayStr=S.data.daily.time[d];if(!dayStr)return[];
  var timeArr=S.data.hourly.time||[];var idx=[];
  for(var i=0;i<timeArr.length;i++){if(timeArr[i].indexOf(dayStr)===0)idx.push(i);}
  return idx;
}
// Get hourly array for a model+field, only for given indices
function hVals(mid,field,indices){
  var key=field+"_"+mid;
  var arr=S.data.hourly[key];if(!arr)return[];
  var out=[];for(var i=0;i<indices.length;i++){if(arr[indices[i]]!=null)out.push(arr[indices[i]]);}
  return out;
}
// Per-variable weight helper: getW(modelId, varType)
// varType: 'temp','precip','wind','wind_dir','wx'
function getW(mid,vt){
  if(!S.weights)return 1;
  var m=S.weights[vt||'temp'];
  if(m&&m[mid]!=null)return m[mid];
  // fallback for old format or missing variable
  if(typeof S.weights[mid]==='number')return S.weights[mid];
  return 1;
}
function dD(d){if(!S.data||!S.data.daily||!S.data.daily.time)return"";return new Date(S.data.daily.time[d]).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"});}
function dDF(d){if(!S.data||!S.data.daily||!S.data.daily.time)return"";var dt=new Date(S.data.daily.time[d]);var s=dt.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"});s=s.replace(/^(\w)/,function(c){return c.toUpperCase();}).replace(/\s(\w+)$/,function(m,w){return" "+w.charAt(0).toUpperCase()+w.slice(1);});return s.replace(/^(\S+)/,"$1,");}

function syn(day){
  var idx=dayIdx(day);
  // Per-variable weight arrays
  var wtT=MODELS.map(function(m){return getW(m.id,'temp');});
  var wtP=MODELS.map(function(m){return getW(m.id,'precip');});
  var wtW=MODELS.map(function(m){return getW(m.id,'wind');});
  var wtX=MODELS.map(function(m){return getW(m.id,'wx');});
  // Per-model daily aggregates from hourly data
  var tMx=[],tMn=[],pr=[],sf=[],wi=[],pb=[];
  MODELS.forEach(function(m){
    var t=hVals(m.id,"temperature_2m",idx);
    tMx.push(t.length?Math.max.apply(null,t):null);
    tMn.push(t.length?Math.min.apply(null,t):null);
    var p=hVals(m.id,"precipitation",idx);
    pr.push(p.length?p.reduce(function(a,b){return a+b;},0):null);
    var s=hVals(m.id,"snowfall",idx);
    sf.push(s.length?s.reduce(function(a,b){return a+b;},0):null);
    var w=hVals(m.id,"wind_speed_10m",idx);
    wi.push(w.length?Math.max.apply(null,w):null);
    var pp=hVals(m.id,"precipitation_probability",idx);
    pb.push(pp.length?Math.max.apply(null,pp):null);
  });
  var precS=st(pr,wtP);var probS=st(pb,wtP);var snowS=st(sf,wtP);
  // Weather icon: for each hour, vote across models ‚Üí get 24 voted icons ‚Üí take mode
  var hourIcons=[];
  for(var hi=0;hi<idx.length;hi++){
    var hCodes=[],hWts=[];
    MODELS.forEach(function(m,mi){
      var a=S.data.hourly["weather_code_"+m.id];
      if(a&&a[idx[hi]]!=null){hCodes.push(a[idx[hi]]);hWts.push(wtX[mi]);}
    });
    var v=votedWx(hCodes,hWts);
    if(v!=null)hourIcons.push(v);
  }
  // Mode of the 24 voted icons = dominant weather of the day
  var dom=3;
  if(hourIcons.length){
    var freq={};for(var k=0;k<hourIcons.length;k++){freq[hourIcons[k]]=(freq[hourIcons[k]]||0)+1;}
    var bf=0;Object.keys(freq).forEach(function(c){if(freq[c]>bf){bf=freq[c];dom=Number(c);}});
  }
  return{tMax:st(tMx,wtT),tMin:st(tMn,wtT),prec:precS,snow:snowS,wind:st(wi,wtW),prob:probS,dom:dom};
}

// Weather Underground PWS
function saveWU(){
  var sta=document.getElementById("wuSta").value.trim();
  if(!sta){document.getElementById("wuSts").textContent="Inserisci Station ID";return;}
  localStorage.setItem("wu_sta_"+S.city.name,sta);
  document.getElementById("wuSts").textContent="Salvato!";
  document.getElementById("wuPnl").classList.remove("open");
  fetchWU();
}
function loadWUC(){
  var s=localStorage.getItem("wu_sta_"+S.city.name)||"";
  return s?s.split(",").map(function(x){return x.trim();}).filter(Boolean):[];
}
function fetchWU(){
  var ids=loadWUC();if(!ids.length){S.wuData=[];return;}
  console.log("WU fetch:",ids);
  S.wuData=[];
  var done=0;
  ids.forEach(function(sta){
    fetch("/api/wu?stationId="+encodeURIComponent(sta))
      .then(function(r){return r.json().then(function(j){return{ok:r.ok,status:r.status,data:j};});})
      .then(function(res){
        if(res.ok&&res.data&&res.data.observations&&res.data.observations.length>0){
          S.wuData.push(res.data.observations[0]);
        }
      })
      .catch(function(e){console.error("WU fetch err:",sta,e);})
      .finally(function(){
        done++;
        if(done===ids.length){renderLive();if(S.data)renderDt();}
      });
  });
}

// METAR
function fetchM(){
  var icao=ICAO[S.city.name];
  if(!icao){S.mData=null;return;}
  fetch("/api/metar?ids="+icao)
    .then(function(r){
      if(r.status===204)return "[]";
      if(!r.ok)throw new Error("HTTP "+r.status);
      return r.text();
    })
    .then(function(txt){
      if(!txt||!txt.trim()){S.mData=null;return;}
      var j;try{j=JSON.parse(txt);}catch(e){console.error("METAR parse:",e,txt.substring(0,200));S.mData=null;return;}
      var arr=Array.isArray(j)?j:j.data?j.data:[j];
      if(!arr.length){S.mData=null;return;}
      S.mData=arr[0];S.mErr=null;renderLive();if(S.data)renderDt();
    })
    .catch(function(e){console.error("METAR err:",e);S.mData=null;S.mErr=e.message||"errore";renderLive();if(S.data)renderDt();});
}
function mCloudD(clouds){
  if(!clouds||!clouds.length)return"N/D";
  var c=clouds[clouds.length-1];
  var cv={"CLR":"Sereno","SKC":"Sereno","FEW":"Poco nuvoloso","SCT":"Parz. nuvoloso","BKN":"Nuvoloso","OVC":"Coperto","VV":"Visib. vert."};
  var d=cv[c.cover]||c.cover;if(c.base)d+=" "+c.base+"ft";return d;
}
function mWxD(wx){
  if(!wx)return null;
  var map={"-RA":"Pioggia legg.","RA":"Pioggia","+RA":"Pioggia forte","-SN":"Neve legg.","SN":"Neve","BR":"Foschia","FG":"Nebbia","HZ":"Caligine","TS":"Temporale","TSRA":"Temp. pioggia","-DZ":"Pioviggine","DZ":"Pioviggine","-SHRA":"Rovesci legg.","SHRA":"Rovesci","+SHRA":"Rovesci forti"};
  return map[wx]||wx;
}

// City
function loadFavs(){try{return JSON.parse(localStorage.getItem("pm_favs")||"[]");}catch(e){return [];}}
function saveFavs(favs){localStorage.setItem("pm_favs",JSON.stringify(favs));}
function isFav(){var favs=loadFavs();return favs.some(function(f){return f.name===S.city.name;});}
function toggleStar(){
  var favs=loadFavs();
  var idx=favs.findIndex(function(f){return f.name===S.city.name;});
  if(idx>=0){favs.splice(idx,1);}
  else{favs.push({name:S.city.name,lat:S.city.lat,lon:S.city.lon});}
  saveFavs(favs);renderCB();
}
function isBuiltIn(name){return CITIES.some(function(c){return c.name===name;});}
function renderCB(){
  var el=document.getElementById("cbtns");
  var star=isFav()?"‚òÖ":"‚òÜ";
  var starCls=isFav()?"star-on":"star-off";
  var favs=loadFavs();
  var hint=(!favs.length&&S.city.name==="Milano")?'<span class="fav-hint">seleziona ‚òÜ per salvare nei preferiti</span>':'';
  el.innerHTML='<span class="city-active">'+S.city.name+'</span><span class="city-star '+starCls+'" onclick="toggleStar()">'+star+'</span>'+hint;
  // User favorites
  var ufel=document.getElementById("userFavBtns");
  var uhtml="";
  // Always show Milano if not current city and not in favs
  var milInFavs=favs.some(function(f){return f.name==="Milano";});
  if(S.city.name!=="Milano"&&!milInFavs){uhtml+='<button class="cbtn" onclick="selC(0)">Milano</button>';}
  for(var i=0;i<favs.length;i++){
    var f=favs[i];
    var isBI=isBuiltIn(f.name);
    var biIdx=isBI?CITIES.findIndex(function(c){return c.name===f.name;}):-1;
    var isCur=f.name===S.city.name;
    var style=isCur?' style="opacity:0.5;pointer-events:none"':'';
    if(biIdx>=0) uhtml+='<button class="cbtn"'+style+' onclick="selC('+biIdx+')">'+f.name+'</button>';
    else uhtml+='<button class="cbtn"'+style+' onclick="selCC(\''+f.name.replace(/'/g,"\\'")+'\','+f.lat+','+f.lon+')">'+f.name+'</button>';
  }
  ufel.innerHTML=uhtml;
  var showFavBar=favs.length>0||(S.city.name!=="Milano");
  document.getElementById("userFavToggle").style.display=showFavBar?"inline-block":"none";
}
function toggleUserFav(){
  var el=document.getElementById("userFavCities");
  el.style.display=el.style.display==="none"?"flex":"none";
}
function selC(idx){S.city=CITIES[idx];localStorage.setItem("pm_lastCity",S.city.name);document.getElementById("sinp").value="";hideDD();document.getElementById("userFavCities").style.display="none";renderCB();fetchAll();}
function selCC(name,lat,lon){S.city={name:name,lat:lat,lon:lon};localStorage.setItem("pm_lastCity",name);document.getElementById("sinp").value="";hideDD();document.getElementById("userFavCities").style.display="none";renderCB();fetchAll();}

document.getElementById("sinp").addEventListener("input",function(){
  clearTimeout(stm);var q=this.value.trim();if(q.length<2){hideDD();return;}
  stm=setTimeout(function(){searchC(q);},400);
});
function searchC(q){
  fetch("https://geocoding-api.open-meteo.com/v1/search?name="+encodeURIComponent(q)+"&count=5&language=it")
    .then(function(r){return r.json();})
    .then(function(j){
      var res=j.results||[];
      if(res.length){
        var dd=document.getElementById("sdd");
        dd.innerHTML=res.map(function(r){
          return '<div class="ddi" onclick="selCC(\''+r.name.replace(/'/g,"\\'")+'\','+r.latitude+','+r.longitude+')"><b>'+r.name+'</b> <span style="color:#6b7280">'+(r.admin1||"")+(r.country?" ("+r.country+")":"")+'</span></div>';
        }).join("");
        dd.style.display="block";
      }else hideDD();
    }).catch(function(){hideDD();});
}
function hideDD(){document.getElementById("sdd").style.display="none";}

// Fetch
// --- Skill-based Model Calibration ---
function getCalCacheKey(){return "pm_cal4_"+S.city.name;}
function loadCalCache(){
  try{
    var raw=localStorage.getItem(getCalCacheKey());
    if(!raw)return null;
    var c=JSON.parse(raw);
    // Cache valid for 12 hours
    if(Date.now()-c.ts>12*3600*1000)return null;
    // Validate new per-variable format
    if(!c.weights||!c.weights.temp)return null;
    S.calSource=c.src||"era5";
    return c.weights;
  }catch(e){return null;}
}
function saveCalCache(weights){
  try{localStorage.setItem(getCalCacheKey(),JSON.stringify({ts:Date.now(),weights:weights,src:S.calSource}));}catch(e){}
}

function calibrate(){
  var cached=loadCalCache();
  if(cached){S.weights=cached;S.calStatus="cached";renderCalBadge();if(S.data)renderAll();return;}
  S.calStatus="loading";S.calSource=null;renderCalBadge();
  var lat=S.city.lat,lon=S.city.lon;
  // ERA5 has 5-7 day lag
  var end=new Date();end.setDate(end.getDate()-7);
  var start=new Date(end);start.setDate(start.getDate()-30);
  var fmt=function(d){return d.toISOString().slice(0,10);};
  var ids=MODELS.map(function(m){return m.id;}).join(",");
  // Per-variable calibration: request temperature, precipitation, wind speed, wind direction
  var dailyF="temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max,wind_direction_10m_dominant";
  var fcUrl="https://historical-forecast-api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon
    +"&daily="+dailyF+"&models="+ids
    +"&start_date="+fmt(start)+"&end_date="+fmt(end)
    +"&timezone=auto";
  // ERA5 reanalysis as ground truth
  var eraUrl="https://archive-api.open-meteo.com/v1/archive?latitude="+lat+"&longitude="+lon
    +"&daily="+dailyF
    +"&start_date="+fmt(start)+"&end_date="+fmt(end)
    +"&timezone=auto";
  Promise.all([fetch(fcUrl).then(function(r){return r.json();}),fetch(eraUrl).then(function(r){return r.json();})])
    .then(function(res){
      var mData=res[0],era=res[1];
      if(!mData.daily){S.calStatus="error";renderCalBadge();return;}
      if(!era.daily||!era.daily.temperature_2m_max){S.calStatus="error";renderCalBadge();return;}
      var refDates=era.daily.time;
      var refTmax=era.daily.temperature_2m_max;
      var refTmin=era.daily.temperature_2m_min;
      var refPrec=era.daily.precipitation_sum;
      var refWind=era.daily.wind_speed_10m_max;
      var refWdir=era.daily.wind_direction_10m_dominant;
      S.calSource="era5";
      var nDays=refDates.length;
      var mDates=mData.daily.time;
      // Per-variable weight maps
      var wTemp={},wPrec={},wWind={},wWdir={};
      MODELS.forEach(function(m){
        var tmax=mData.daily["temperature_2m_max_"+m.id];
        var tmin=mData.daily["temperature_2m_min_"+m.id];
        var prec=mData.daily["precipitation_sum_"+m.id];
        var wind=mData.daily["wind_speed_10m_max_"+m.id];
        var wdir=mData.daily["wind_direction_10m_dominant_"+m.id];
        var errT=[],errP=[],errW=[],errD=[];
        for(var d=0;d<nDays;d++){
          var di=mDates?mDates.indexOf(refDates[d]):-1;
          if(di<0)continue;
          // Temperature MAE (avg of tmax+tmin errors)
          var te=0,tc=0;
          if(tmax&&tmax[di]!=null&&refTmax[d]!=null){te+=Math.abs(tmax[di]-refTmax[d]);tc++;}
          if(tmin&&tmin[di]!=null&&refTmin[d]!=null){te+=Math.abs(tmin[di]-refTmin[d]);tc++;}
          if(tc>0)errT.push(te/tc);
          // Precipitation MAE
          if(prec&&prec[di]!=null&&refPrec&&refPrec[d]!=null)errP.push(Math.abs(prec[di]-refPrec[d]));
          // Wind speed MAE
          if(wind&&wind[di]!=null&&refWind&&refWind[d]!=null)errW.push(Math.abs(wind[di]-refWind[d]));
          // Wind direction MAE (circular distance)
          if(wdir&&wdir[di]!=null&&refWdir&&refWdir[d]!=null){
            var dd=Math.abs(wdir[di]-refWdir[d]);
            errD.push(Math.min(dd,360-dd));
          }
        }
        // MAE ‚Üí weight: 1/MAE (min 3 data points required)
        function maeToW(arr){
          if(arr.length<3)return 1;
          var mae=arr.reduce(function(a,b){return a+b;},0)/arr.length;
          return mae<0.01?10:1/mae;
        }
        wTemp[m.id]=maeToW(errT);
        wPrec[m.id]=maeToW(errP);
        wWind[m.id]=maeToW(errW);
        wWdir[m.id]=maeToW(errD);
      });
      // Normalize each variable: sqrt ‚Üí mean=1 ‚Üí cap [0.5, 1.5]
      function normW(w){
        MODELS.forEach(function(m){w[m.id]=Math.sqrt(w[m.id]);});
        var arr=MODELS.map(function(m){return w[m.id];});
        var mean=arr.reduce(function(a,b){return a+b;},0)/arr.length;
        if(mean>0)MODELS.forEach(function(m){w[m.id]=w[m.id]/mean;});
        MODELS.forEach(function(m){w[m.id]=Math.max(0.5,Math.min(1.5,w[m.id]));});
      }
      normW(wTemp);normW(wPrec);normW(wWind);normW(wWdir);
      // Weather code weights: average of temp + precip (icons depend on both)
      var wWx={};
      MODELS.forEach(function(m){wWx[m.id]=(wTemp[m.id]+wPrec[m.id])/2;});
      var weights={temp:wTemp,precip:wPrec,wind:wWind,wind_dir:wWdir,wx:wWx};
      S.weights=weights;S.calStatus="done";
      saveCalCache(weights);
      renderCalBadge();
      if(S.data)renderAll();
    })
    .catch(function(e){console.error("Calibration error:",e);S.calStatus="error";S.weights=null;renderCalBadge();});
}

function renderCalBadge(){
  var el=document.getElementById("calBadge");if(!el)return;
  var dk=window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches;
  if(S.calStatus==="loading"){el.textContent="‚è≥ Calibrazione...";el.style.display="inline";el.style.color=dk?"#eab308":"#ca8a04";}
  else if(S.calStatus==="done"||S.calStatus==="cached"){el.textContent="‚úì Calibrato";el.style.display="inline";el.style.color=dk?"#4ade80":"#16a34a";}
  else if(S.calStatus==="error"){el.textContent="‚ö† Non calibrato";el.style.display="inline";el.style.color=dk?"#f87171":"#dc2626";}
  else{el.style.display="none";}
}
function buildWeightRows(varKeys){
  // varKeys: array of {k, n} ‚Äî variable keys and display names
  if(!S.weights)return'';
  var dk=window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches;
  var h='';
  varKeys.forEach(function(v,vi){
    var wMap=S.weights[v.k];if(!wMap)return;
    if(vi>0)h+='<div style="height:12px"></div>';
    if(varKeys.length>1)h+='<div style="font-size:12px;font-weight:700;color:'+(dk?'#94a3b8':'#6b7280')+';margin-bottom:6px">'+v.n+'</div>';
    var sorted=MODELS.slice().sort(function(a,b){return(wMap[b.id]||1)-(wMap[a.id]||1);});
    var total=sorted.reduce(function(s,m){return s+(wMap[m.id]||1);},0);
    sorted.forEach(function(m,i){
      var w=wMap[m.id]||1;
      var pct=Math.round(w/total*100);
      var barW=Math.max(4,Math.round(pct*1.8));
      h+='<div class="hr-popup-row">';
      h+='<span class="hr-rank">'+(i+1)+'</span>';
      h+='<span class="hr-dot" style="background:'+m.color+'"></span>';
      h+='<span class="hr-mname">'+m.name+'</span>';
      h+='<span class="hr-mvals">';
      h+='<span style="min-width:32px;text-align:right;font-weight:600">'+pct+'%</span>';
      h+='<span style="min-width:80px;display:flex;align-items:center"><span style="display:inline-block;height:6px;border-radius:3px;width:'+barW+'px;background:'+m.color+';opacity:0.7"></span></span>';
      h+='</span></div>';
    });
  });
  return h;
}
function showVarWeights(varType){
  if(!S.weights)return;
  var names={temp:'\ud83c\udf21\ufe0f Temperatura',precip:'\ud83c\udf27\ufe0f Precipitazioni',wind:'\ud83d\udca8 Vento (velocit\u00e0)',wind_dir:'\ud83e\udded Vento (direzione)',wx:'\ud83c\udf24\ufe0f Icone meteo'};
  var keys=[{k:varType,n:names[varType]||varType}];
  // For precip, also show wind_dir subgroup if relevant
  if(varType==='wind')keys.push({k:'wind_dir',n:'\ud83e\udded Direzione'});
  var src=S.calSource==="era5"?"ERA5 reanalysis (ECMWF)":"best_match";
  var h='<h3>Pesi ‚Äî '+(names[varType]||varType)+'</h3>';
  h+='<div class="hr-sub">Calibrazione MAE 30gg vs '+src+' \u00b7 '+S.city.name+'</div>';
  h+=buildWeightRows(keys);
  document.getElementById("hrPopupContent").innerHTML=h;
  document.getElementById("hrPopup").classList.add("open");
}
function showWeights(){
  if(!S.weights)return;
  var keys=[{k:'temp',n:'\ud83c\udf21\ufe0f Temperatura'},{k:'precip',n:'\ud83c\udf27\ufe0f Precipitazioni'},{k:'wind',n:'\ud83d\udca8 Vento (vel.)'},{k:'wind_dir',n:'\ud83e\udded Vento (dir.)'},{k:'wx',n:'\ud83c\udf24\ufe0f Icone meteo'}];
  var src=S.calSource==="era5"?"ERA5 reanalysis (ECMWF)":"best_match";
  var h='<h3>Pesi calibrati per variabile</h3>';
  h+='<div class="hr-sub">MAE 30gg vs '+src+' \u00b7 '+S.city.name+'</div>';
  h+=buildWeightRows(keys);
  document.getElementById("hrPopupContent").innerHTML=h;
  document.getElementById("hrPopup").classList.add("open");
}

function fetchAll(){
  var lat=S.city.lat,lon=S.city.lon;
  document.getElementById("ldEl").style.display="block";
  document.getElementById("erEl").style.display="none";
  document.getElementById("cnt").style.display="none";
  renderCB();
  S.wuData=[];S.current=null;S.weights=null;S.calStatus=null;
  calibrate();
  // Fetch server-side station defaults, then init stations
  fetch("/api/stations?city="+encodeURIComponent(S.city.name))
    .then(function(r){return r.json();})
    .then(function(srv){
      // WU: server default (array) or localStorage (comma-separated)
      var wStaLS=localStorage.getItem("wu_sta_"+S.city.name)||"";
      var wArr=wStaLS?wStaLS.split(",").map(function(x){return x.trim();}).filter(Boolean):(srv.wu||[]);
      if(wArr.length){loadWUC=function(){return wArr;};}
      var hasW=wArr.length>0;
      var wFromLS=!!wStaLS;
      document.getElementById("wuTogEl").style.display=wFromLS?"block":"none";
      document.getElementById("wuPnl").classList.remove("open");
      if(wArr.length){document.getElementById("wuSta").value=wArr.join(", ");}
      if(hasW){fetchWU();}
    })
    .catch(function(e){
      console.warn("Station config fetch failed, using localStorage only:",e);
      var wIds=loadWUC();var hasW=wIds.length>0;
      document.getElementById("wuTogEl").style.display=hasW?"block":"none";
      if(hasW)fetchWU();
    });
  fetchM();
  var ids=MODELS.map(function(m){return m.id;}).join(",");
  var url="https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m,relative_humidity_2m,pressure_msl,apparent_temperature,precipitation,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,wind_speed_10m_max,precipitation_probability_max&hourly=temperature_2m,precipitation_probability,precipitation,snowfall,weather_code,wind_speed_10m,wind_direction_10m&models="+ids+"&timezone=auto&forecast_days=16";
  fetch(url)
    .then(function(r){if(!r.ok)throw new Error("HTTP "+r.status);return r.json();})
    .then(function(j){S.data=j;S.current=j.current||null;document.getElementById("ldEl").style.display="none";document.getElementById("secPrev").style.display="block";document.getElementById("cnt").style.display="block";renderAll();})
    .catch(function(e){document.getElementById("ldEl").style.display="none";document.getElementById("erEl").textContent="Errore: "+e.message;document.getElementById("erEl").style.display="block";});
}

function getCurTemp(){
  if(!S.data||!S.data.hourly)return null;
  var now=new Date();var h=now.getHours();
  var temps=[];var twts=[];var curTime=null;
  MODELS.forEach(function(m){
    var key="temperature_2m_"+m.id;
    var arr=S.data.hourly[key];
    if(arr&&arr[h]!=null){temps.push(arr[h]);twts.push(getW(m.id,'temp'));}
  });
  if(!temps.length)return null;
  var wSum=twts.reduce(function(a,b){return a+b;},0);
  var avg=wSum>0?temps.reduce(function(a,v,i){return a+v*twts[i];},0)/wSum:temps.reduce(function(a,b){return a+b;},0)/temps.length;
  return{temp:r1(avg),hour:String(h).padStart(2,"0")+":00",count:temps.length,temps:temps};
}

function getHourlyData(mode,day){
  if(!S.data||!S.data.hourly)return null;
  var timeArr=S.data.hourly.time||[];
  var startIdx=-1,count=24;
  if(day===0||day===undefined){
    // Today: from current hour, next 24h
    var now=new Date();var curH=now.getHours();
    var todayStr=now.toISOString().slice(0,10);
    for(var i=0;i<timeArr.length;i++){
      var t=timeArr[i];if(t.indexOf(todayStr)===0){
        var hr=parseInt(t.slice(11,13));
        if(hr===curH){startIdx=i;break;}
      }
    }
  }else{
    // Other days: from hour 0 of that day
    if(S.data.daily&&S.data.daily.time&&S.data.daily.time[day]){
      var dayStr=S.data.daily.time[day];
      for(var i=0;i<timeArr.length;i++){
        if(timeArr[i].indexOf(dayStr)===0){startIdx=i;break;}
      }
    }
  }
  if(startIdx<0)return null;
  var effMode=mode==="probsnow"?"prob":mode;
  var keyPfx=effMode==="temp"?"temperature_2m_":effMode==="prob"?"precipitation_probability_":effMode==="wind"?"wind_speed_10m_":effMode==="winddir"?"wind_direction_10m_":effMode==="snow"?"snowfall_":"precipitation_";
  var cType=effMode==="temp"?"temp":effMode==="prob"?"wind":effMode==="wind"?"wind":"precip";
  // Map mode to per-variable weight type
  var wType=effMode==="temp"?"temp":effMode==="wind"?"wind":effMode==="winddir"?"wind_dir":"precip";
  var pts=[];
  for(var h=0;h<count;h++){
    var idx=startIdx+h;if(idx>=timeArr.length)break;
    var vals=[];var vwts=[];
    MODELS.forEach(function(m){
      var arr=S.data.hourly[keyPfx+m.id];
      if(arr&&arr[idx]!=null){vals.push(arr[idx]);vwts.push(getW(m.id,wType));}
    });
    if(!vals.length)continue;
    var wSum=vwts.reduce(function(a,b){return a+b;},0);
    var avg=wSum>0?vals.reduce(function(a,v,i){return a+v*vwts[i];},0)/wSum:vals.reduce(function(a,b){return a+b;},0)/vals.length;
    var spread=vals.length>1?Math.max.apply(null,vals)-Math.min.apply(null,vals):0;
    var cl=cL(spread,cType);
    var hr=parseInt(timeArr[idx].slice(11,13));
    var hCodes=[],hWts=[];
    MODELS.forEach(function(m){
      var wArr=S.data.hourly["weather_code_"+m.id];
      if(wArr&&wArr[idx]!=null){hCodes.push(wArr[idx]);hWts.push(getW(m.id,'wx'));}
    });
    var wc=votedWx(hCodes,hWts);
    pts.push({hr:hr,val:(mode==="prec"||mode==="snow")?avg:Math.round(avg),wc:wc,cls:cl.cls,idx:idx});
  }
  return pts.length?pts:null;
}

// Conditions strip: hour + weather icons only
function buildConditionsChart(day){
  var tPts=getHourlyData("temp",day);
  if(!tPts)return'';
  var mob=window.innerWidth<=600;
  var colW=mob?48:56;
  var totalW=tPts.length*colW;
  var svgH=mob?44:48;
  var cols='';
  for(var i=0;i<tPts.length;i++){
    var tp=tPts[i];
    var hrStr=String(tp.hr).padStart(2,"0");
    cols+='<div class="hc-col" style="height:'+svgH+'px;cursor:pointer" onclick="showHrPopup('+tp.idx+')">';
    cols+='<div class="hc-hr" style="position:absolute;top:1px">'+hrStr+'</div>';
    cols+='<div class="hc-ico" style="position:absolute;top:'+(mob?20:22)+'px;font-size:'+(mob?18:20)+'px">'+wI(tp.wc)+'</div>';
    cols+='</div>';
  }
  var h='<div class="hc-sec"><div class="hc-title">Condizioni</div>';
  h+='<div class="hc-wrap"><div class="hc-row" style="height:'+svgH+'px">'+cols+'</div></div></div>';
  return h;
}

// Combined chart: temp curve only (icons moved to Condizioni)
function buildComboChart(day){
  var tPts=getHourlyData("temp",day);
  if(!tPts)return'';
  var mob=window.innerWidth<=600;
  var dk=window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches;
  var colW=mob?48:56;
  var totalW=tPts.length*colW;
  var hrH=18;
  var tempH=mob?80:100;
  var padTop=hrH+4;
  var padBot=6;
  var svgH=padTop+tempH+padBot;
  var tVals=tPts.map(function(p){return p.val;});
  var tMin=Math.min.apply(null,tVals),tMax=Math.max.apply(null,tVals);
  var tRange=tMax-tMin||1;
  function tY(v){return padTop+tempH-(((v-tMin)/tRange)*tempH);}
  function xPos(i){return i*colW+colW/2;}
  var clrMap={ca:"#22c55e",cm:"#eab308",cl:"#ef4444"};
  var axClr=dk?"#94a3b8":"#9ca3af";
  var svg='<svg class="hc-svg" width="'+totalW+'" height="'+svgH+'">';
  var tSteps=tRange<=2?[tMin,tMax]:[tMin,Math.round((tMin+tMax)/2),tMax];
  tSteps.forEach(function(v){
    svg+='<line x1="0" y1="'+tY(v)+'" x2="'+totalW+'" y2="'+tY(v)+'" stroke="'+axClr+'" stroke-opacity="0.15" stroke-dasharray="3,3"/>';
  });
  for(var i=0;i<tPts.length-1;i++){
    var c=clrMap[tPts[i].cls]||"#22c55e";
    svg+='<line x1="'+xPos(i)+'" y1="'+tY(tPts[i].val)+'" x2="'+xPos(i+1)+'" y2="'+tY(tPts[i+1].val)+'" stroke="'+c+'" stroke-width="2.5" stroke-linecap="round"/>';
  }
  for(var i=0;i<tPts.length;i++){
    var c=clrMap[tPts[i].cls]||"#22c55e";
    svg+='<circle cx="'+xPos(i)+'" cy="'+tY(tPts[i].val)+'" r="3" fill="'+c+'"/>';
  }
  svg+='</svg>';
  var cols='';
  for(var i=0;i<tPts.length;i++){
    var tp=tPts[i];
    var hrStr=String(tp.hr).padStart(2,"0");
    var tempY=tY(tp.val)-8;
    if(tempY<padTop)tempY=tY(tp.val)+4;
    cols+='<div class="hc-col" style="height:'+svgH+'px;cursor:pointer" onclick="showHrPopup('+tp.idx+')">';
    cols+='<div class="hc-hr" style="position:absolute;top:1px">'+hrStr+'</div>';
    cols+='<div class="hc-val" style="position:absolute;top:'+tempY+'px">'+Math.round(tp.val)+'¬∞</div>';
    cols+='</div>';
  }
  var tFs=mob?9:10;var mL=mob?24:28;
  var leftOv='<div style="position:absolute;left:0;top:0;width:'+mL+'px;height:'+svgH+'px;z-index:3;pointer-events:none">';
  tSteps.forEach(function(v){
    leftOv+='<div style="position:absolute;left:0;top:'+(tY(v)-5)+'px;width:'+(mL-3)+'px;text-align:right;font-size:'+tFs+'px;color:'+axClr+'">'+v+'¬∞</div>';
  });
  leftOv+='</div>';
  var h='<div class="hc-sec"><div class="hc-title">Temperatura (\u00b0C)</div>';
  h+='<div style="position:relative">'+leftOv+'<div class="hc-wrap" style="margin-left:'+mL+'px"><div class="hc-row" style="height:'+svgH+'px">'+svg+cols+'</div></div></div></div>';
  return h;
}

function buildHourlyChart(mode,title,unit,day){
  var pts=getHourlyData(mode,day);
  if(!pts)return'';
  // Get precipitation/snowfall data for bars if prob mode
  var precPts=null;
  if(mode==="prob")precPts=getHourlyData("prec",day);
  else if(mode==="probsnow")precPts=getHourlyData("snow",day);
  var mob=window.innerWidth<=600;
  var dk=window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches;
  var defPadTop=(mode==="prob"||mode==="probsnow")?mob?22:26:mob?40:50;
  var colW=mob?48:56,padTop=defPadTop,padBot=mob?26:32,chartH=mob?80:100;
  var padL=0;
  var totalW=pts.length*colW;
  var vals=pts.map(function(p){return p.val;});
  var vMin=Math.min.apply(null,vals),vMax=Math.max.apply(null,vals);
  if(mode==="prob"||mode==="probsnow"){vMin=0;vMax=100;}
  var range=vMax-vMin||1;
  function yPos(v){return padTop+chartH-(((v-vMin)/range)*chartH);}
  function xPos(i){return padL+i*colW+colW/2;}
  var svgH=padTop+chartH+padBot;
  var clrMap={ca:"#22c55e",cm:"#eab308",cl:"#ef4444"};
  var svg='<svg class="hc-svg" width="'+totalW+'" height="'+svgH+'">';
  // Dashed guidelines for probability
  if(mode==="prob"||mode==="probsnow"){
    var axClr=dk?"#94a3b8":"#9ca3af";
    [0,50,100].forEach(function(v){
      var y=yPos(v);
      svg+='<line x1="0" y1="'+y+'" x2="'+totalW+'" y2="'+y+'" stroke="'+axClr+'" stroke-opacity="0.2" stroke-dasharray="3,3"/>';
    });
  }
  // Dashed guidelines for temperature
  if(mode==="temp"){
    var axClr=dk?"#94a3b8":"#9ca3af";
    var tRange=vMax-vMin;
    var tStepsG=[];
    if(tRange<=2){tStepsG=[vMin,vMax];}
    else{tStepsG=[vMin,Math.round((vMin+vMax)/2),vMax];}
    tStepsG.forEach(function(v){
      var y=yPos(v);
      svg+='<line x1="0" y1="'+y+'" x2="'+totalW+'" y2="'+y+'" stroke="'+axClr+'" stroke-opacity="0.15" stroke-dasharray="3,3"/>';
    });
  }
  // Draw precipitation bars if prob mode
  var precMaxScale=0;
  if(precPts&&precPts.length){
    var precVals=precPts.map(function(p){return p.val;});
    var precMax=Math.max.apply(null,precVals)||1;
    precMax=Math.max(precMax,10);
    precMax=precMax<=10?10:precMax<=20?20:precMax<=50?50:Math.ceil(precMax/10)*10;
    precMaxScale=precMax;
    var barW=colW*0.5;
    var barBot=padTop+chartH;
    for(var i=0;i<precPts.length;i++){
      var rv=Math.round(precPts[i].val*10)/10;
      var hasProb=pts[i]&&pts[i].val>0;
      if(rv>=0.1){
        var barH=Math.max(4,(precPts[i].val/precMax)*chartH*0.8);
        var bx=xPos(i)-barW/2;
        var by=barBot-barH;
        svg+='<rect x="'+bx+'" y="'+by+'" width="'+barW+'" height="'+barH+'" rx="3" fill="'+(dk?"#38bdf8":"#0284c7")+'" opacity="'+(dk?"0.35":"0.25")+'"/>';
        svg+='<text x="'+xPos(i)+'" y="'+(by-3)+'" text-anchor="middle" font-size="11" font-weight="700" fill="'+(dk?"#7dd3fc":"#0284c7")+'">'+r1(precPts[i].val)+'</text>';
      } else if(hasProb){
        // Trace bar: probability > 0 but negligible quantity
        var barH=3;
        var bx=xPos(i)-barW/2;
        var by=barBot-barH;
        svg+='<rect x="'+bx+'" y="'+by+'" width="'+barW+'" height="'+barH+'" rx="2" fill="'+(dk?"#38bdf8":"#0284c7")+'" opacity="'+(dk?"0.2":"0.15")+'"/>';
      }
    }
  }
  // Draw colored line segments
  for(var i=0;i<pts.length-1;i++){
    var x1=xPos(i),y1=yPos(pts[i].val);
    var x2=xPos(i+1),y2=yPos(pts[i+1].val);
    var c=clrMap[pts[i].cls]||"#22c55e";
    svg+='<line x1="'+x1+'" y1="'+y1+'" x2="'+x2+'" y2="'+y2+'" stroke="'+c+'" stroke-width="2.5" stroke-linecap="round"/>';
  }
  for(var i=0;i<pts.length;i++){
    var x=xPos(i),y=yPos(pts[i].val);
    var c=clrMap[pts[i].cls]||"#22c55e";
    svg+='<circle cx="'+x+'" cy="'+y+'" r="3" fill="'+c+'"/>';
  }
  svg+='</svg>';
  // Get wind direction data for wind mode
  var windDirPts=null;
  if(mode==="wind")windDirPts=getHourlyData("winddir",day);
  var cols='';
  for(var i=0;i<pts.length;i++){
    var p=pts[i];var y=yPos(p.val);
    var hrStr=String(p.hr).padStart(2,"0");
    var valStr=mode==="prec"?r1(p.val):(mode==="prob"||mode==="probsnow")?Math.round(p.val)+"%":mode==="wind"?Math.round(p.val):Math.round(p.val);
    // Place label above point; move below only if it overlaps with top area
    var labelY=y-22;
    var icoBottom=mode==="wind"?36:0;
    if(labelY<icoBottom) labelY=y+6;
    cols+='<div class="hc-col" style="height:'+svgH+'px;cursor:pointer" onclick="showHrPopup('+p.idx+')">';
    cols+='<div class="hc-hr" style="position:absolute;top:4px">'+hrStr+'</div>';
    if(mode==="wind"&&windDirPts&&windDirPts[i]){var deg=windDirPts[i].val;var ac=dk?'#60a5fa':'#2563eb';cols+='<div style="position:absolute;top:14px;width:28px;height:28px;display:flex;align-items:center;justify-content:center"><svg width="24" height="24" viewBox="0 0 24 24" style="transform:rotate('+deg+'deg);filter:drop-shadow(0 0 2px rgba(37,99,235,0.4))"><path d="M12 20 L12 6" stroke="'+ac+'" stroke-width="2.5" stroke-linecap="round"/><path d="M7 11 L12 4 L17 11" stroke="'+ac+'" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div>';}
    cols+='<div class="hc-val" style="position:absolute;top:'+labelY+'px">'+valStr+'</div>';
    cols+='</div>';
  }
  var h='<div class="hc-sec"><div class="hc-title">'+title+(unit?' ('+unit+')':'')+'</div>';
  var spacer='';
  var pctOverlay='';
  var mmOverlay='';
  var leftOv='';
  var rightOv='';
  var mL=0,mR=0;
  if(mode==="prob"||mode==="probsnow"){
    var axClr=dk?"#94a3b8":"#9ca3af";
    var axFs=mob?9:10;
    mL=mob?30:34;
    leftOv='<div style="position:absolute;left:0;top:0;width:'+mL+'px;height:'+svgH+'px;z-index:3;pointer-events:none">';
    [0,50,100].forEach(function(v){
      var y=padTop+chartH-(((v-0)/100)*chartH);
      leftOv+='<div style="position:absolute;left:0;top:'+(y-5)+'px;width:'+(mL-3)+'px;text-align:right;font-size:'+axFs+'px;color:'+axClr+'">'+v+'%</div>';
    });
    leftOv+='</div>';
    if(precMaxScale>0){
      var mmClr=dk?"#7dd3fc":"#0284c7";
      var mmFs=mob?9:10;
      var barBot=padTop+chartH;
      mR=mob?26:30;
      rightOv='<div style="position:absolute;right:0;top:0;width:'+mR+'px;height:'+svgH+'px;z-index:3;pointer-events:none">';
      var precUnitLabel=mode==="probsnow"?"cm":"mm";
      rightOv+='<div style="position:absolute;right:2px;top:'+(padTop-12)+'px;font-size:'+(mmFs-1)+'px;color:'+mmClr+';opacity:0.5">'+precUnitLabel+'</div>';
      [0,Math.round(precMaxScale/2),precMaxScale].forEach(function(v){
        var y=barBot-((v/precMaxScale)*chartH*0.8);
        rightOv+='<div style="position:absolute;right:2px;top:'+(y-5)+'px;font-size:'+mmFs+'px;color:'+mmClr+';opacity:0.6">'+v+'</div>';
      });
      rightOv+='</div>';
    }
  }
  if(mode==="temp"){
    var tClr=dk?"#94a3b8":"#9ca3af";
    var tFs=mob?9:10;
    mL=mob?24:28;
    mR=mob?24:28;
    var tSteps=[];
    var tRange=vMax-vMin;
    if(tRange<=2){tSteps=[vMin,vMax];}
    else if(tRange<=6){tSteps=[vMin,Math.round((vMin+vMax)/2),vMax];}
    else{var mid=Math.round((vMin+vMax)/2);tSteps=[vMin,mid,vMax];}
    leftOv='<div style="position:absolute;left:0;top:0;width:'+mL+'px;height:'+svgH+'px;z-index:3;pointer-events:none">';
    tSteps.forEach(function(v){
      var y=yPos(v);
      leftOv+='<div style="position:absolute;left:0;top:'+(y-5)+'px;width:'+(mL-3)+'px;text-align:right;font-size:'+tFs+'px;color:'+tClr+'">'+v+'¬∞</div>';
    });
    leftOv+='</div>';
    rightOv='<div style="position:absolute;right:0;top:0;width:'+mR+'px;height:'+svgH+'px;z-index:3;pointer-events:none">';
    tSteps.forEach(function(v){
      var y=yPos(v);
      rightOv+='<div style="position:absolute;right:2px;top:'+(y-5)+'px;font-size:'+tFs+'px;color:'+tClr+'">'+v+'¬∞</div>';
    });
    rightOv+='</div>';
  }
  h+='<div style="position:relative">'+leftOv+rightOv+'<div class="hc-wrap" style="margin-left:'+mL+'px;margin-right:'+mR+'px"><div class="hc-row" style="height:'+svgH+'px">'+svg+spacer+cols+'</div></div></div></div>';
  return h;
}

function renderHourly(){}

function showHrPopup(idx){
  if(!S.data||!S.data.hourly)return;
  var timeStr=S.data.hourly.time[idx]||"";
  var hr=timeStr.slice(11,13)||"--";
  var dayPart=timeStr.slice(0,10)||"";
  // Collect per-model data
  var rows=[];
  MODELS.forEach(function(m){
    var t=S.data.hourly["temperature_2m_"+m.id];
    var p=S.data.hourly["precipitation_probability_"+m.id];
    var pr=S.data.hourly["precipitation_"+m.id];
    var sf=S.data.hourly["snowfall_"+m.id];
    var w=S.data.hourly["wind_speed_10m_"+m.id];
    var wc=S.data.hourly["weather_code_"+m.id];
    if(!t||t[idx]==null)return;
    var weight=(getW(m.id,'temp')+getW(m.id,'precip')+getW(m.id,'wind'))/3;
    rows.push({
      name:m.name,origin:m.origin,color:m.color,weight:weight,
      temp:t?t[idx]:null,
      prob:p?p[idx]:null,
      prec:pr?pr[idx]:null,
      snow:sf?sf[idx]:null,
      wind:w?w[idx]:null,
      wcode:wc?wc[idx]:null
    });
  });
  // Sort by weight descending
  rows.sort(function(a,b){return b.weight-a.weight;});
  var h='<h3>Ore '+hr+':00</h3>';
  h+='<div class="hr-sub">'+dayPart+' ¬∑ '+rows.length+' provider ¬∑ Ordinati per peso calibrazione</div>';
  h+='<div class="hr-popup-row" style="border-bottom:1px solid rgba(255,255,255,0.15);padding-bottom:4px;margin-bottom:2px;font-size:10px;color:#64748b">';
  h+='<span class="hr-rank"></span><span style="width:8px;margin-right:8px"></span>';
  h+='<span class="hr-mname">Provider</span>';
  h+='<span class="hr-mvals"><span></span><span>¬∞C</span><span>Prob</span><span>Prec.</span><span>Vento</span><span>Peso</span></span></div>';
  var wTotalAll=MODELS.reduce(function(a,m){return a+((getW(m.id,'temp')+getW(m.id,'precip')+getW(m.id,'wind'))/3);},0);
  rows.forEach(function(r,i){
    var pct=wTotalAll>0?Math.round(r.weight/wTotalAll*100):0;
    h+='<div class="hr-popup-row">';
    h+='<span class="hr-rank">'+(i+1)+'</span>';
    h+='<span class="hr-dot" style="background:'+r.color+'"></span>';
    h+='<span class="hr-mname" title="'+r.origin+'">'+r.name+'</span>';
    h+='<span class="hr-mvals">';
    h+='<span>'+wI(r.wcode)+'</span>';
    h+='<span>'+(r.temp!=null?Math.round(r.temp)+'¬∞':'--')+'</span>';
    h+='<span style="color:#38bdf8">'+(r.prob!=null?Math.round(r.prob)+'%':'--')+'</span>';
    var isSnow=r.wcode!=null&&((r.wcode>=71&&r.wcode<=77)||(r.wcode>=85&&r.wcode<=86));
    if(isSnow&&r.snow!=null&&r.snow>=0.1)h+='<span style="color:#e0f2fe">'+r1(r.snow)+'cm‚ùÑ</span>';
    else if(r.prec!=null&&r.prec>=0.1)h+='<span style="color:#7dd3fc">'+r1(r.prec)+'mm</span>';
    else h+='<span></span>';
    h+='<span style="color:#a3e635">'+(r.wind!=null?Math.round(r.wind)+'km/h':'--')+'</span>';
    h+='<span style="color:#94a3b8">'+pct+'%</span>';
    h+='</span></div>';
  });
  // Weighted average
  if(rows.length){
    var wSum=rows.reduce(function(a,r){return a+r.weight;},0);
    var avgT=wSum>0?rows.reduce(function(a,r){return a+(r.temp||0)*r.weight;},0)/wSum:0;
    var avgP=wSum>0?rows.reduce(function(a,r){return a+(r.prob||0)*r.weight;},0)/wSum:0;
    var avgW=wSum>0?rows.reduce(function(a,r){return a+(r.wind||0)*r.weight;},0)/wSum:0;
    var synthCodes=rows.map(function(r){return r.wcode;});
    var synthWts=rows.map(function(r){return r.weight;});
    var synthWc=votedWx(synthCodes,synthWts);
    h+='<div class="hr-popup-avg"><span>Sintesi ponderata</span><span>';
    h+=wI(synthWc)+' '+Math.round(avgT)+'¬∞ ¬∑ '+Math.round(avgP)+'% ¬∑ '+Math.round(avgW)+' km/h</span></div>';
  }
  // Weight legend
  h+='<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">Peso = accuratezza storica su ERA5 (ultimi 30gg)</div>';
  document.getElementById("hrPopupContent").innerHTML=h;
  document.getElementById("hrPopup").classList.add("open");
}
function closeHrPopup(){document.getElementById("hrPopup").classList.remove("open");}

function lcBuild(icon,bg,labelClr,label,temp,rows,ts,url){
  var tag=url?'a':'div';
  var h='<'+tag+' class="lc" style="background:'+bg+'"'+(url?' href="'+url+'" target="_blank" rel="noopener"':'')+'>';
  h+='<div class="lc-icon">'+icon+'</div>';
  h+='<div class="lc-data">';
  h+='<div class="lc-label" style="color:'+labelClr+'">'+label+'</div>';
  h+='<div class="lc-temp">'+temp+'</div>';
  for(var i=0;i<rows.length;i++)h+='<div class="lc-row">'+(rows[i]||'&nbsp;')+'</div>';
  if(ts)h+='<div class="lc-ts" style="color:'+labelClr+'">'+ts+'</div>';
  h+='</div></'+tag+'>';
  return h;
}
function renderLive(){
  var hasLive=false;
  var h='<div class="live-row">';
  // 1. Open-Meteo (weather code from weighted multi-model vote for current hour)
  if(S.current&&S.current.temperature_2m!=null){
    var c=S.current;
    var ts='';
    if(c.time){
      var p=c.time.split(/[-T:]/);
      var utcMs=Date.UTC(+p[0],p[1]-1,+p[2],+p[3],+(p[4]||0))-(S.data&&S.data.utc_offset_seconds||0)*1000;
      ts=new Date(utcMs).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
    }
    // Derive weather code from weighted multi-model vote for current hour
    var liveWc=c.weather_code;
    if(S.data&&S.data.hourly&&S.data.hourly.time){
      var nowH=new Date().getHours();
      var todayS=new Date().toISOString().slice(0,10);
      var curIdx=-1;
      for(var ti=0;ti<S.data.hourly.time.length;ti++){var tt=S.data.hourly.time[ti];if(tt.indexOf(todayS)===0&&parseInt(tt.slice(11,13))===nowH){curIdx=ti;break;}}
      if(curIdx>=0){
        var lcCodes=[],lcWts=[];
        MODELS.forEach(function(m){var wa=S.data.hourly["weather_code_"+m.id];if(wa&&wa[curIdx]!=null){lcCodes.push(wa[curIdx]);lcWts.push(getW(m.id,'wx'));}});
        var voted=votedWx(lcCodes,lcWts);
        if(voted!=null)liveWc=voted;
      }
    }
    var perc=c.apparent_temperature!=null&&Math.abs(c.apparent_temperature-c.temperature_2m)>=1?'Percepita '+c.apparent_temperature.toFixed(1)+'¬∞':'';
    var rows=[perc,wD(liveWc),'Vento '+c.wind_speed_10m.toFixed(0)+' km/h'+(c.wind_direction_10m!=null?' '+c.wind_direction_10m+'¬∞':''),'Umidit√† '+c.relative_humidity_2m+'%'];
    var omUrl='https://open-meteo.com/en/docs#latitude='+S.city.lat+'&longitude='+S.city.lon;
    h+=lcBuild(wI(liveWc),'linear-gradient(135deg,#1e40af,#3b82f6)','#93c5fd',S.city.name,c.temperature_2m.toFixed(1)+'¬∞C',rows,ts?'Aggiornamento '+ts:'',omUrl);
    hasLive=true;
  }
  // 2. METAR
  if(S.mData&&S.mData.temp!=null){
    var mName=S.mData.name||ICAO[S.city.name]||"METAR";
    var mTs="";
    if(S.mData.obsTime){var md=typeof S.mData.obsTime==="number"?new Date(S.mData.obsTime*1000):new Date(S.mData.obsTime);mTs=md.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});}
    var mPerc=S.mData.dewp!=null?'Dew point '+S.mData.dewp.toFixed(1)+'¬∞':'';
    var mWx=mWxD(S.mData.wxString)||mCloudD(S.mData.clouds)||'';
    var mWind=S.mData.wspd!=null?'Vento '+(S.mData.wspd*1.852).toFixed(0)+' km/h'+(S.mData.wdir!=null?' '+S.mData.wdir+'¬∞':''):'';
    // derive icon from METAR cloud/wx
    var mIcon='üå°Ô∏è';
    if(S.mData.wxString){var wxl=S.mData.wxString;if(wxl.indexOf('TS')>=0)mIcon='‚õàÔ∏è';else if(wxl.indexOf('SN')>=0)mIcon='‚ùÑÔ∏è';else if(wxl.indexOf('RA')>=0||wxl.indexOf('DZ')>=0||wxl.indexOf('SH')>=0)mIcon='üåßÔ∏è';else if(wxl.indexOf('FG')>=0||wxl.indexOf('BR')>=0)mIcon='üå´Ô∏è';}
    else if(S.mData.clouds&&S.mData.clouds.length){var top=S.mData.clouds[S.mData.clouds.length-1].cover;if(top==='OVC'||top==='BKN')mIcon='‚òÅÔ∏è';else if(top==='SCT'||top==='FEW')mIcon='‚õÖ';else mIcon='‚òÄÔ∏è';}
    else mIcon='‚òÄÔ∏è';
    var mIcao=ICAO[S.city.name]||'';
    var mUrl=mIcao?'https://aviationweather.gov/data/metar/?id='+mIcao:'';
    h+=lcBuild(mIcon,'linear-gradient(135deg,#065f46,#059669)','#86efac',mName,S.mData.temp.toFixed(1)+'¬∞C',[mPerc,mWx,mWind,''],mTs?'Aggiornamento '+mTs:'',mUrl);
    hasLive=true;
  }
  // 3. WU (multiple stations)
  for(var wi=0;wi<S.wuData.length;wi++){
    var wd=S.wuData[wi];
    if(!wd||!wd.metric||wd.metric.temp==null)continue;
    var wm=wd.metric;
    var wTs=wd.epoch?new Date(wd.epoch*1000).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}):"";
    var wWind=wm.windSpeed!=null?'Vento '+wm.windSpeed.toFixed(0)+' km/h'+(wd.winddir!=null?' '+wd.winddir+'¬∞':''):'';
    var wHum=wd.humidity!=null?'Umidit√† '+wd.humidity+'%':'';
    var wuAliases={"IMILAN6036":"Bocconi"};
    var wLabel=wuAliases[wd.stationID]||wd.neighborhood||wd.stationID||'Weather Underground';
    var wwc=wuWx(wd,S.city.lat);var wIcon=wwc!=null?wI(wwc):'üå°Ô∏è';var wWxD=wwc!=null?wD(wwc):'';
    var wuUrl=wd.stationID?'https://www.wunderground.com/dashboard/pws/'+wd.stationID:'';
    h+=lcBuild(wIcon,'linear-gradient(135deg,#7c2d12,#c2410c)','#fdba74',wLabel,wm.temp.toFixed(1)+'¬∞C',['',wWxD,wWind,wHum],wTs?'Aggiornamento '+wTs:'',wuUrl);
    hasLive=true;
  }
  h+='</div>';
  // Legend
  h+='<div class="lc-leg">';
  h+='<span><i style="background:#3b82f6"></i>Previsione</span>';
  h+='<span><i style="background:#059669"></i>Aeroporto pi√π vicino</span>';
  h+='<span><i style="background:#c2410c"></i>Stazioni personali WU</span>';
  h+='</div>';
  h+='<div style="text-align:center;margin-top:10px;opacity:.45;font-size:11px;font-style:italic">Clicca su una card per aprire il sito della fonte</div>';
  var el=document.getElementById("liveCard");var sl=document.getElementById("secLive");
  if(hasLive){sl.style.display="block";el.style.display="block";document.getElementById("liveContent").innerHTML=h;}
  else{sl.style.display="none";el.style.display="none";}
}
// === Cena in terrazza ===
var TERR_DEFAULTS={hrFrom:19,hrTo:23,minTemp:17,maxTemp:35,minWind:0,maxWind:20,minRain:0,maxRain:30};
function loadTerrCfg(){try{var s=localStorage.getItem("pm_terr");var c=s?JSON.parse(s):Object.assign({},TERR_DEFAULTS);if(c.maxTemp==null)c.maxTemp=TERR_DEFAULTS.maxTemp;if(c.minWind==null)c.minWind=TERR_DEFAULTS.minWind;if(c.minRain==null)c.minRain=TERR_DEFAULTS.minRain;return c;}catch(e){return Object.assign({},TERR_DEFAULTS);}}
function saveTerrCfg(){
  var tMin=parseInt(document.getElementById("tcfTempMin").value);
  var tMax=parseInt(document.getElementById("tcfTempMax").value);
  if(tMin>tMax){var tmp=tMin;tMin=tMax;tMax=tmp;document.getElementById("tcfTempMin").value=tMin;document.getElementById("tcfTempMax").value=tMax;}
  var wMin=parseInt(document.getElementById("tcfWindMin").value);
  var wMax=parseInt(document.getElementById("tcfWindMax").value);
  if(wMin>wMax){var tmp=wMin;wMin=wMax;wMax=tmp;document.getElementById("tcfWindMin").value=wMin;document.getElementById("tcfWindMax").value=wMax;}
  var rMin=parseInt(document.getElementById("tcfRainMin").value);
  var rMax=parseInt(document.getElementById("tcfRainMax").value);
  if(rMin>rMax){var tmp=rMin;rMin=rMax;rMax=tmp;document.getElementById("tcfRainMin").value=rMin;document.getElementById("tcfRainMax").value=rMax;}
  var cfg={hrFrom:parseInt(document.getElementById("tcfHrFrom").value),hrTo:parseInt(document.getElementById("tcfHrTo").value),minTemp:tMin,maxTemp:tMax,minWind:wMin,maxWind:wMax,minRain:rMin,maxRain:rMax};
  localStorage.setItem("pm_terr",JSON.stringify(cfg));updTerrSlider();renderWk();
}
function updTerrSlider(){
  var tMin=document.getElementById("tcfTempMin").value;
  var tMax=document.getElementById("tcfTempMax").value;
  document.getElementById("tcfTempV").textContent=tMin+'¬∞C ‚Äì '+tMax+'¬∞C';
  var wMin=document.getElementById("tcfWindMin").value;
  var wMax=document.getElementById("tcfWindMax").value;
  document.getElementById("tcfWindV").textContent=wMin+' ‚Äì '+wMax+' km/h';
  var rMin=document.getElementById("tcfRainMin").value;
  var rMax=document.getElementById("tcfRainMax").value;
  document.getElementById("tcfRainV").textContent=rMin+'% ‚Äì '+rMax+'%';
}
function openTerrCfg(){
  var cfg=loadTerrCfg();
  var selF=document.getElementById("tcfHrFrom"),selT=document.getElementById("tcfHrTo");
  selF.innerHTML='';selT.innerHTML='';
  for(var hh=17;hh<=22;hh++){selF.innerHTML+='<option value="'+hh+'"'+(cfg.hrFrom===hh?' selected':'')+'>'+String(hh).padStart(2,'0')+':00</option>';}
  for(var hh=20;hh<=24;hh++){var lbl=hh===24?'00:00':String(hh).padStart(2,'0')+':00';selT.innerHTML+='<option value="'+hh+'"'+(cfg.hrTo===hh?' selected':'')+'>'+lbl+'</option>';}
  document.getElementById("tcfTempMin").value=cfg.minTemp;
  document.getElementById("tcfTempMax").value=cfg.maxTemp;
  document.getElementById("tcfWindMin").value=cfg.minWind;
  document.getElementById("tcfWindMax").value=cfg.maxWind;
  document.getElementById("tcfRainMin").value=cfg.minRain;
  document.getElementById("tcfRainMax").value=cfg.maxRain;
  updTerrSlider();
  document.getElementById("terrCfgOverlay").classList.add("open");
}
function closeTerrCfg(){document.getElementById("terrCfgOverlay").classList.remove("open");}
function evalTerrazza(day){
  if(!S.data||!S.data.hourly||!S.data.hourly.time)return null;
  var cfg=loadTerrCfg();
  var timeArr=S.data.hourly.time;
  // find target date string
  var dateStr;
  if(day===0){dateStr=new Date().toISOString().slice(0,10);}
  else if(S.data.daily&&S.data.daily.time&&S.data.daily.time[day]){dateStr=S.data.daily.time[day];}
  else return null;
  // collect hourly indices in the evening window
  var idxs=[];
  for(var i=0;i<timeArr.length;i++){
    if(timeArr[i].indexOf(dateStr)!==0)continue;
    var hh=parseInt(timeArr[i].slice(11,13));
    if(hh>=cfg.hrFrom&&hh<cfg.hrTo)idxs.push(i);
  }
  if(!idxs.length)return null;
  // evaluate each hour
  var temps=[],winds=[],rains=[],wcs=[];
  for(var j=0;j<idxs.length;j++){
    var idx=idxs[j];
    // weighted temp
    var tv=[],tw=[];
    MODELS.forEach(function(m){var a=S.data.hourly["temperature_2m_"+m.id];if(a&&a[idx]!=null){tv.push(a[idx]);tw.push(getW(m.id,'temp'));}});
    if(tv.length){var ws=tw.reduce(function(a,b){return a+b;},0);temps.push(ws>0?tv.reduce(function(a,v,i){return a+v*tw[i];},0)/ws:tv.reduce(function(a,b){return a+b;},0)/tv.length);}
    // weighted wind
    var wv=[],ww=[];
    MODELS.forEach(function(m){var a=S.data.hourly["wind_speed_10m_"+m.id];if(a&&a[idx]!=null){wv.push(a[idx]);ww.push(getW(m.id,'wind'));}});
    if(wv.length){var ws2=ww.reduce(function(a,b){return a+b;},0);winds.push(ws2>0?wv.reduce(function(a,v,i){return a+v*ww[i];},0)/ws2:wv.reduce(function(a,b){return a+b;},0)/wv.length);}
    // weighted rain prob
    var rv=[],rw=[];
    MODELS.forEach(function(m){var a=S.data.hourly["precipitation_probability_"+m.id];if(a&&a[idx]!=null){rv.push(a[idx]);rw.push(getW(m.id,'precip'));}});
    if(rv.length){var ws3=rw.reduce(function(a,b){return a+b;},0);rains.push(ws3>0?rv.reduce(function(a,v,i){return a+v*rw[i];},0)/ws3:rv.reduce(function(a,b){return a+b;},0)/rv.length);}
    // weather code
    var hCodes=[],hWts=[];
    MODELS.forEach(function(m){var a=S.data.hourly["weather_code_"+m.id];if(a&&a[idx]!=null){hCodes.push(a[idx]);hWts.push(getW(m.id,'wx'));}});
    var wc=votedWx(hCodes,hWts);if(wc!=null)wcs.push(wc);
  }
  if(!temps.length)return null;
  var minT=Math.min.apply(null,temps);
  var maxT=Math.max.apply(null,temps);
  var maxW=Math.max.apply(null,winds);
  var maxR=Math.max.apply(null,rains);
  var hasStorm=wcs.some(function(c){return c>=65||(c>=95&&c<=99);});
  // scoring: each dimension 0-100, 100 = perfect
  // temp: penalise both too cold (below minTemp) and too hot (above maxTemp)
  var sTempLow=minT>=cfg.minTemp+3?100:minT>=cfg.minTemp?Math.round((minT-cfg.minTemp)/3*100):0;
  var sTempHigh=maxT<=cfg.maxTemp-3?100:maxT<=cfg.maxTemp?Math.round((cfg.maxTemp-maxT)/3*100):0;
  var sTemp=Math.min(sTempLow,sTempHigh);
  // wind: penalise both too calm (below minWind) and too strong (above maxWind)
  var minW=Math.min.apply(null,winds);
  var sWindLow=cfg.minWind===0?100:minW>=cfg.minWind+3?100:minW>=cfg.minWind?Math.round((minW-cfg.minWind)/3*100):0;
  var sWindHigh=maxW<=cfg.maxWind-3?100:maxW<=cfg.maxWind?Math.round((cfg.maxWind-maxW)/3*100):0;
  var sWind=Math.min(sWindLow,sWindHigh);
  // rain: penalise both too dry (below minRain) and too wet (above maxRain)
  var minR=Math.min.apply(null,rains);
  var sRainLow=cfg.minRain===0?100:minR>=cfg.minRain+5?100:minR>=cfg.minRain?Math.round((minR-cfg.minRain)/5*100):0;
  var sRainHigh=maxR<=cfg.maxRain-5?100:maxR<=cfg.maxRain?Math.round((cfg.maxRain-maxR)/5*100):0;
  var sRain=Math.min(sRainLow,sRainHigh);
  if(hasStorm){sRain=0;}
  // overall = minimum (one bad dimension ruins it)
  var overall=Math.min(sTemp,sWind,sRain);
  var level=overall>=70?'green':overall>=35?'yellow':'red';
  return{overall:overall,level:level,sTemp:sTemp,sWind:sWind,sRain:sRain,minT:minT,maxT:maxT,minW:minW,maxW:maxW,minR:minR,maxR:maxR,hasStorm:hasStorm,cfg:cfg};
}
function renderAll(){renderLive();renderDt();renderWk();renderHourly();
  document.getElementById("ftEl").innerHTML='Dati: Open-Meteo API ¬∑ Provider: ECMWF IFS, ECMWF AIFS, GFS, ICON, M√©t√©o-France, JMA, GEM, UKMO, ItaliaMeteo ARPAE, KNMI, MeteoSwiss, DMI, MET Norway'+(S.wuData.length?' + WU PWS':'')+'<br>METAR: aviationweather.gov (stazioni Aeronautica Militare)';
}
function renderWk(){
  document.getElementById("wkCard").style.display="block";
  var dkM=window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches;
  var pCounts=[];for(var pd=0;pd<16;pd++){var pc=syn(pd).tMax.count;if(pc>0)pCounts.push(pc);}
  var pMin=Math.min.apply(null,pCounts),pMax=Math.max.apply(null,pCounts);
  var provTxt=pMin===pMax?pMin+' provider':'da '+pMax+' a '+pMin+' provider';
  var seraClr=dkM?'#94a3b8':'#64748b';
  var terrSpan=' ¬∑ <span onclick="openTerrCfg()" style="cursor:pointer;border-bottom:1px dotted '+seraClr+';color:'+seraClr+';transition:opacity .15s;font-weight:400;font-size:13px;letter-spacing:0;opacity:.8" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.8">Imposta condizioni ideali</span>';
  document.getElementById("wkTitle").innerHTML='<h2 style="font-size:15px;font-weight:800;letter-spacing:0.3px;color:'+(dkM?'#60a5fa':'#2563eb')+';margin:0">Prossimi 15 giorni'+terrSpan+'</h2>';
  var html="";
  for(var d=0;d<16;d++){
    var s=syn(d);var tc=cL(parseFloat(s.tMax.spread)||0,"temp");
    var clrMap={ca:"#4ade80",cm:"#facc15",cl:"#f87171"};
    var dateClr=clrMap[tc.cls]||"#94a3b8";
    var dateLabel=d===0?"Oggi":d===1?"Domani":dD(d);
    var isDomSnow=s.dom!=null&&((s.dom>=71&&s.dom<=77)||(s.dom>=85&&s.dom<=86));
    var precTxt=isDomSnow&&parseFloat(s.snow.mean)>0?'<span class="wr-prec" style="color:#e0f2fe">'+s.snow.mean+'cm‚ùÑ</span>':parseFloat(s.prec.mean)>0?'<span class="wr-prec">'+s.prec.mean+'mm</span>':"";
    html+='<div class="wr'+(S.day===d?" on":"")+'" onclick="selD('+d+')" style="border-color:'+dateClr+'">';
    html+='<div class="wr-date" style="color:'+dateClr+'">'+dateLabel+'</div>';
    html+='<div class="wr-ico">'+wI(s.dom)+'</div>';
    html+='<div class="wr-temps"><span class="tmn">'+Math.round(s.tMin.mean)+'¬∞</span><span class="tsp">/</span><span class="tmx">'+Math.round(s.tMax.mean)+'¬∞</span></div>';
    html+=precTxt||'<span class="wr-prec" style="visibility:hidden">0mm</span>';
    var te=evalTerrazza(d);
    if(te){
      var sT=te.sTemp>=70?'‚úì':te.sTemp>=35?'~':'‚úó';
      var sW=te.sWind>=70?'‚úì':te.sWind>=35?'~':'‚úó';
      var sR=te.sRain>=70?'‚úì':te.sRain>=35?'~':'‚úó';
      var nc=dkM?'#94a3b8':'#64748b';
      var c=te.cfg;
      html+='<div style="margin-top:6px;font-size:8px;line-height:1.4;color:'+nc+';opacity:.85">';
      html+='<div>'+sT+' '+c.minTemp+'‚Äì'+c.maxTemp+'¬∞</div>';
      html+='<div>'+sW+' '+c.minWind+'‚Äì'+c.maxWind+'km/h</div>';
      html+='<div>'+sR+' '+c.minRain+'‚Äì'+c.maxRain+'%</div>';
      html+='</div>';
    }
    html+='</div>';
  }
  document.getElementById("wkG").innerHTML=html;
  var hintEl=document.getElementById("wkHint");
  if(!hintEl){hintEl=document.createElement("div");hintEl.id="wkHint";hintEl.style.cssText="text-align:center;padding:6px 0 0;opacity:.45;font-size:11px;font-style:italic";hintEl.textContent="Clicca su un giorno per vedere le previsioni orarie";document.getElementById("wkCard").appendChild(hintEl);}
}
function selD(d){S.day=d;renderAll();}
function toggleWind(){S.showWind=!S.showWind;var btn=document.getElementById("windToggle");if(btn){btn.classList.toggle("on",S.showWind);btn.textContent=S.showWind?"Nascondi vento":"Mostra vento";}renderDt();}
function setV(v){
  S.view=v;
  document.querySelectorAll(".tbtn").forEach(function(b){b.classList.toggle("on",b.getAttribute("data-v")===v);});
  document.getElementById("sV").style.display=v==="s"?"block":"none";
  document.getElementById("cV").style.display=v==="c"?"block":"none";
  renderDt();
}
function renderDt(){
  var s=syn(S.day);
  var dkM=window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches;
  var blueC=dkM?'#60a5fa':'#2563eb';
  var provLink=' ¬∑ <span onclick="showWeights()" style="cursor:pointer;border-bottom:1px dotted currentColor;opacity:.6;transition:opacity .15s;font-weight:400;font-size:13px;letter-spacing:0" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.6">Dati da '+s.tMax.count+' provider</span>';
  var dayLabel=S.day===0?'<span style="color:'+blueC+';font-weight:800;letter-spacing:0.3px">Prossime 24 ore'+provLink+'</span>':'<span style="color:'+blueC+';font-weight:800;letter-spacing:0.3px">'+dDF(S.day)+provLink+'</span>';
  document.getElementById("dtT").innerHTML=dayLabel;
  document.getElementById("dtT").parentNode.style.marginBottom=S.day===0?"24px":"16px";
  renderCalBadge();

  if(S.view==="s"){renderSyn();}else{renderCmp();document.getElementById("legendBadge").style.display="none";}
}
function renderSyn(){
  var s=syn(S.day);
  var h='';
  h+=buildConditionsChart(S.day);
  h+=buildComboChart(S.day);
  var dayWc=s.dom;
  var isSnow=(dayWc>=71&&dayWc<=77)||(dayWc>=85&&dayWc<=86);
  var isFrRain=(dayWc>=66&&dayWc<=67);
  var precLabel=isSnow?"Neve":isFrRain?"Pioggia gelata":"Pioggia";
  h+='<div style="margin-top:36px"></div>';
  h+=buildHourlyChart(isSnow?"probsnow":"prob",precLabel+" \u2014 probabilit\u00e0 e quantit\u00e0"+(isSnow?" (cm)":""),"",S.day);
  h+=buildHourlyChart("wind","Vento","km/h",S.day);
  document.getElementById("sV").innerHTML=h;
  // Sync scroll across all hourly charts ‚Äî optimised with rAF
  (function(){
    var wraps=document.getElementById("sV").querySelectorAll(".hc-wrap");
    var raf=0,src=null;
    function onScroll(e){
      if(src&&src!==e.currentTarget)return;
      src=e.currentTarget;
      if(!raf){raf=requestAnimationFrame(function(){
        var left=src.scrollLeft;
        wraps.forEach(function(o){if(o!==src)o.scrollLeft=left;});
        raf=0;src=null;
      });}
    }
    wraps.forEach(function(el){el.addEventListener("scroll",onScroll,{passive:true});});
  })();
  // Render legend badge
  document.getElementById("legendBadge").style.display="block";
  document.getElementById("legendBadge").innerHTML='<div class="hc-legend aff-badge">Consenso tra provider <span><span style="display:inline-block;width:18px;height:3px;border-radius:2px;background:#22c55e;vertical-align:middle"></span> alto</span><span><span style="display:inline-block;width:18px;height:3px;border-radius:2px;background:#eab308;vertical-align:middle"></span> medio</span><span><span style="display:inline-block;width:18px;height:3px;border-radius:2px;background:#ef4444;vertical-align:middle"></span> basso</span></div>';
}
function renderCmp(){
  var d=S.day;
  var h='<div style="overflow-x:auto"><table><thead><tr><th style="text-align:left">Modello</th><th>Meteo</th><th>T.Max</th><th>T.Min</th><th>Prec.</th><th>Vento</th><th>Prob.%</th></tr></thead><tbody>';
  var cIdx=dayIdx(d);
  for(var i=0;i<MODELS.length;i++){
    var m=MODELS[i];
    var wc=hVals(m.id,"weather_code",cIdx);var code=wc.length?votedWx(wc,null):null;
    var t=hVals(m.id,"temperature_2m",cIdx);
    var tmx=t.length?Math.max.apply(null,t):null;
    var tmn=t.length?Math.min.apply(null,t):null;
    var p=hVals(m.id,"precipitation",cIdx);var pSum=p.length?p.reduce(function(a,b){return a+b;},0):null;
    var sn=hVals(m.id,"snowfall",cIdx);var snSum=sn.length?sn.reduce(function(a,b){return a+b;},0):null;
    var w=hVals(m.id,"wind_speed_10m",cIdx);var wMax=w.length?Math.max.apply(null,w):null;
    var pp=hVals(m.id,"precipitation_probability",cIdx);var ppMax=pp.length?Math.max.apply(null,pp):null;
    h+='<tr><td><div class="mn" style="color:'+m.color+'">'+m.name+'</div><div class="mm">'+m.origin+' ¬∑ '+m.res+'</div></td>';
    h+='<td style="text-align:center"><span style="font-size:18px">'+wI(code)+'</span><div style="font-size:10px;color:#6b7280">'+wD(code)+'</div></td>';
    h+='<td style="text-align:center;font-weight:600;color:#ef4444">'+r1(tmx)+'</td>';
    h+='<td style="text-align:center;font-weight:600;color:#3b82f6">'+r1(tmn)+'</td>';
    var mSnow=code!=null&&((code>=71&&code<=77)||(code>=85&&code<=86));
    if(mSnow&&snSum!=null&&snSum>=0.1)h+='<td style="text-align:center;color:#93c5fd">'+r1(snSum)+'cm‚ùÑ</td>';
    else h+='<td style="text-align:center">'+r1(pSum)+'mm</td>';
    h+='<td style="text-align:center">'+r1(wMax)+'</td>';
    h+='<td style="text-align:center">'+r1(ppMax)+'</td></tr>';
  }
  // WU PWS rows (only day 0, one per station)
  if(d===0){for(var wri=0;wri<S.wuData.length;wri++){
    var wrd=S.wuData[wri];if(!wrd||!wrd.metric||wrd.metric.temp==null)continue;
    var wrm=wrd.metric;
    h+='<tr style="background:linear-gradient(90deg,#fff7ed,#ffedd5)"><td><div class="mn" style="color:#7c2d12">WU '+(wrd.stationID||"")+ ' <span style="display:inline-block;background:#7c2d12;color:#fdba74;font-size:10px;font-weight:600;padding:1px 6px;border-radius:4px;margin-left:4px">LIVE</span></div><div class="mm">Weather Underground PWS</div></td>';
    h+='<td style="text-align:center">--</td>';
    h+='<td style="text-align:center;font-weight:600;color:#ef4444">'+r1(wrm.temp)+'</td>';
    h+='<td style="text-align:center">--</td>';
    h+='<td style="text-align:center">'+r1(wrm.precipTotal)+'mm</td>';
    h+='<td style="text-align:center">'+r1(wrm.windSpeed)+'</td>';
    h+='<td style="text-align:center">--</td></tr>';
  }}
  h+='</tbody></table></div>';
  document.getElementById("cV").innerHTML=h;
}

// Init
var lc=localStorage.getItem("pm_lastCity");
if(lc){
  var found=CITIES.find(function(c){return c.name===lc;});
  if(found){S.city=found;}
  else{var favs=loadFavs();var ff=favs.find(function(f){return f.name===lc;});if(ff)S.city={name:ff.name,lat:ff.lat,lon:ff.lon};}
}
// Auto-add cities with WU stations to favorites (alphabetically)
(function(){
  var favs=loadFavs();
  // 1. Hardcoded WU cities (always in favorites)
  var defaultWU=["Bormio","Garbagnate","Manduria","Milano","Torino"];
  // 2. Also scan localStorage for user-added WU stations
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.indexOf("wu_sta_")===0){
      var v=localStorage.getItem(k);
      if(v&&v.trim()){
        var cn=k.replace("wu_sta_","");
        if(defaultWU.indexOf(cn)<0)defaultWU.push(cn);
      }
    }
  }
  defaultWU.sort(function(a,b){return a.localeCompare(b);});
  var changed=false;
  defaultWU.forEach(function(cn){
    var already=favs.some(function(f){return f.name===cn;});
    if(!already){
      var ci=CITIES.find(function(c){return c.name===cn;});
      if(ci){favs.push({name:ci.name,lat:ci.lat,lon:ci.lon});}
      else{favs.push({name:cn,lat:0,lon:0});}
      changed=true;
    }
  });
  if(changed){
    favs.sort(function(a,b){return a.name.localeCompare(b.name);});
    saveFavs(favs);
  }
})();
renderCB();
fetchAll();
// Auto-refresh METAR + WU every 10 min
setInterval(function(){
  fetchM();
  fetchWU();
},600000);
</script>
</body>
</html>